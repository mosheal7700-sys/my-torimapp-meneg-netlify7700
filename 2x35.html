<DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>×××©×§ × ×™×”×•×œ ×ª×•×¨×™× - v1</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="./manifest_admin.json">
<meta name="theme-color" content="#000000">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
<style>
/* --- ×”×’×“×¨×•×ª ××©×ª× ×™× (×‘×¨×™×¨×ª ××—×“×œ: ××¦×‘ ×›×”×”) --- */
:root {
  --bg-body: #0f172a;       /* ×›×—×•×œ ×œ×™×œ×” ×¢××•×§ */
  --bg-panel: #1e293b;      /* ×¤×× ×œ×™× ×›×”×™× */
  --bg-header: #1e293b;     /* ×¡×¨×’×œ ×¢×œ×™×•×Ÿ */
  --bg-input: #334155;      /* ××™× ×¤×•×˜×™× */
  --text-main: #f1f5f9;     /* ×˜×§×¡×˜ ×œ×‘×Ÿ */
  --text-muted: #94a3b8;    /* ×˜×§×¡×˜ ××¤×•×¨ */
  --border-color: rgba(255,255,255,0.1);
  
  --accent-blue: #3b82f6;
  --accent-green: #ffffff;
  --accent-red: #ef4444;
  --accent-gold: #f59e0b;
  
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
  --border-radius: 8px;
}

/* --- ×”×’×“×¨×•×ª ×œ××¦×‘ ×‘×”×™×¨ (Light Mode) --- */
body.light-mode {
  --bg-body: #f3f4f6;       /* ××¤×•×¨ ×‘×”×™×¨ ×××•×“ */
  --bg-panel: #ffffff;      /* ×œ×‘×Ÿ */
  --bg-header: #ffffff;     /* ×œ×‘×Ÿ */
  --bg-input: #ffffff;      /* ×œ×‘×Ÿ */
  --text-main: #111827;     /* ×©×—×•×¨ */
  --text-muted: #6b7280;    /* ××¤×•×¨ ×›×”×” */
  --border-color: #e5e7eb;  /* ××¤×•×¨ ×‘×”×™×¨ ×œ××¡×’×¨×•×ª */
  
  --accent-blue: #2563eb;
  --accent-green: #059669;
  --accent-red: #dc2626;
  --accent-gold: #d97706;
  
  --shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* --- ×¢×™×¦×•×‘ ×›×œ×œ×™ --- */
body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background-color: var(--bg-body);
  color: var(--text-main);
  margin: 0;
  overflow: hidden;
  height: 100vh;
  font-size: 13px;
  direction: rtl;
  transition: background-color 0.3s, color 0.3s;
}

/* ×¡×¨×’×œ ×¢×œ×™×•×Ÿ */
.top-header {
  height: 60px;
  background: var(--bg-header);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  box-shadow: var(--shadow);
  border-bottom: 1px solid var(--border-color);
  z-index: 100;
  position: relative;
}

.header-title { font-size: 1.4em; font-weight: bold; color: var(--text-main); }
.header-actions { display: flex; align-items: center; gap: 10px; }

/* ×›×¤×ª×•×¨×™× ×‘×¡×¨×’×œ */
.action-btn {
  display: flex; align-items: center; gap: 6px;
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
  background: var(--bg-input);
  color: var(--text-main);
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9em;
  transition: all 0.2s;
}
.action-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
.btn-excel { background: var(--accent-gold); color: #fff; border: none; }
.btn-print { background: var(--bg-panel); color: var(--text-main); }
.btn-theme { background: transparent; border: 1px solid var(--accent-blue); color: var(--accent-blue); }

/* ××ª×’ ×”×™×¡×˜×•×¨×™×” */
.history-wrapper {
  display: flex; align-items: center; gap: 8px;
  background: var(--bg-input);
  padding: 6px 12px;
  border-radius: 20px;
  border: 1px solid var(--border-color);
}

/* ××‘× ×” ×¨××©×™ */
#main-container {
  display: flex; flex-direction: row;
  height: calc(100vh - 60px);
  padding: 15px; gap: 15px;
  box-sizing: border-box;
}

.panel {
  background: var(--bg-panel);
  padding: 15px;
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--border-color);
  display: flex; flex-direction: column; overflow: hidden;
}

/* ××œ×× ×˜×™× */
input, select {
  background: var(--bg-input); color: var(--text-main);
  border: 1px solid var(--border-color); border-radius: 6px;
  padding: 8px; width: 100%; box-sizing: border-box; text-align: center;
  transition: border 0.3s;
}
input:focus { outline: none; border-color: var(--accent-blue); }
h3 { color: var(--accent-blue); text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-top: 0; }
label { color: var(--text-muted); display: block; margin-bottom: 4px; }

/* ×¢××•×“×•×ª */
#configPanelWrapper { flex: 0 0 260px; overflow-y: auto; }
#calendarPanel { flex: 0 0 320px; display: flex; flex-direction: column; }
#slotsWrapper { flex: 1; min-width: 300px; background: var(--bg-input); }

/* ×§×œ× ×“×¨ */
#calendarHeader { display: flex; justify-content: space-between; margin-bottom: 10px; color: var(--text-main); }
#calendarHeader button { background: transparent; border: none; color: var(--text-main); font-size: 1.2em; cursor: pointer; }
#weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; color: var(--text-muted); margin-bottom: 5px; }
#calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }

.day {
  aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
  border-radius: 50%; cursor: pointer; color: var(--text-main); border: 1px solid transparent;
}
.day:hover:not(.disabled) { background: var(--bg-input); }

.day.apply-selected {
  background: rgba(59,130,246,0.25);
  border: 2px dashed #3b82f6;
  color: #ffffff;
  font-weight: bold;
}

/* --- ×¢×™×¦×•×‘ ××—×™×“ ×œ××¦×‘ "×”×—×œ×” ×œ×¤×™ ×ª××¨×™×›×™× × ×¤×¨×“×™×" --- */

/* ×›×œ×œ ×–×” ×ª×•×¤×¡ ×›×œ ×™×•× ×©×™×© ×œ×• ××ª ×”××—×œ×§×” apply-selected, ×›×•×œ×œ ×”×™×•× ×”× ×•×›×—×™ ××• ×”× ×‘×—×¨ */
.day.apply-selected,
.day.selected-day.apply-selected,
.day.today.apply-selected {
  /* ×¦×‘×¢ ×¨×§×¢ ××—×™×“ ×•×‘×•×œ×˜ (×œ××©×œ ×¡×’×•×œ ××• ×›×ª×•×, ×©×•× ×” ××”×›×—×•×œ ×”×¨×’×™×œ) */
  background: #8b5cf6 !important;
  
  /* ×’×‘×•×œ ××—×™×“ */
  border: 2px dashed #ffffff !important;
  
  /* ×¦×‘×¢ ×˜×§×¡×˜ ××—×™×“ */
  color: #ffffff !important;
  
  /* ×”×“×’×©×” ××—×™×“×” */
  font-weight: 800 !important;
  
  /* ××¤×§×˜×™× × ×•×¡×¤×™× ×œ××—×™×“×•×ª */
  border-radius: 50% !important;
  box-shadow: 0 0 10px rgba(139, 92, 246, 0.6) !important;
  opacity: 1 !important;
  transform: scale(0.95); /* ×”×§×˜× ×” ×§×œ×” ×œ×–×™×”×•×™ */
}
/* ×”×ª××¨×™×š ×”× ×‘×—×¨ - ×ª×™×§×•×Ÿ × ×¨××•×ª ×”××¡×¤×¨ */
.day.selected-day {
  border: 2px solid #3b82f6 !important; /* ×›×—×•×œ × ×™××•×Ÿ ×‘×•×œ×˜ */
  border-radius: 50% !important;        /* ×¢×™×’×•×œ ××•×©×œ× */
  background-color: #3b82f6 !important; /* ××™×œ×•×™ ×›×—×•×œ ×›×“×™ ×œ×™×¦×•×¨ ×‘××” ×œ××¡×¤×¨ */
  color: #ffffff !important;           /* ×”×›×¨×—×ª ×¦×‘×¢ ×˜×§×¡×˜ ×œ×‘×Ÿ ×‘×•×”×§ */
  font-weight: 800 !important;         /* ×’×•×¤×Ÿ ×¢×‘×” ×•×‘×•×œ×˜ ×‘××™×•×—×“ */
  width: 35px;
  height: 35px;
  margin: auto;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); /* ×”×™×œ×” ×›×—×•×œ×” ×¢×“×™× ×” */
}

.day.has-slots { font-weight: bold; position: relative; }
.day.has-slots::after { content: ''; position: absolute; bottom: 3px; width: 4px; height: 4px; background: var(--accent-green); border-radius: 50%; }
.day.past { opacity: 0.5; }
.day.disabled { opacity: 0.2; cursor: default; }
.day.history-available { color: var(--accent-gold); border: 1px solid var(--accent-gold); }

/* --- ×¢×™×¦×•×‘ ×ª×•×¨×™× (×›×•×œ×œ ×”×ª×™×§×•× ×™× ×”×¡×•×¤×™×™×) --- */
#slotsContainer { flex: 1; overflow-y: auto; padding: 5px; }

.slot {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px; margin-bottom: 8px;
  background: var(--bg-panel);
  border-radius: 6px;
  border-right: 4px solid #ccc;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* ×ª×•×¨ ×¤× ×•×™ */
.slot.free { border-right-color: var(--accent-green); }
.slot.free strong { color: var(--accent-green); }

/* ×ª×™×§×•×Ÿ: ×ª×•×¨ ×¤× ×•×™ ×‘××¦×‘ ×‘×”×™×¨ - ×’×•×•×Ÿ ×× ×˜×” ×¢×“×™×Ÿ */
body.light-mode .slot.free {
  background: #8aff8a;
  border: 1px solid #d1fae5;
}
body.light-mode .slot.free:hover { background: #ecfdf5; }

/* ×ª×•×¨ ××•×–××Ÿ - ×ª×™×§×•×Ÿ ×œ××¦×‘ ×›×”×” */
.slot.booked {
  border-right-color: var(--accent-blue);
  background-color: #1e3a8a; /* ×›×—×•×œ ×¢××•×§ ×‘×•×œ×˜ */
  border: 1px solid #2563eb;
}
.slot.booked strong { color: #93c5fd; }
.slot.booked div { color: #dbeafe; }

/* ×ª×•×¨ ××•×–××Ÿ - ×ª×™×§×•×Ÿ ×œ××¦×‘ ×‘×”×™×¨ */
body.light-mode .slot.booked {
  background: #dbeafe; /* ×ª×›×œ×ª ×‘×”×™×¨ */
  border: 1px solid #509fff;
  color: inherit;
}
body.light-mode .slot.booked strong { color: var(--accent-blue); }
body.light-mode .slot.booked div { color: inherit; }

/* ×—×¡×•× */
.slot.blocked { border-right-color: var(--text-muted); opacity: 0.6; border-style: dashed; }

/* ××¤×¨×™×“×™× */
.break-separator {
  background: rgba(245, 158, 11, 0.1); color: var(--accent-gold);
  padding: 5px; margin: 10px 0; text-align: center; border-radius: 12px;
  font-weight: bold; font-size: 0.9em; border: 1px solid rgba(245, 158, 11, 0.2);
}

/* ×§×• ××¤×¨×™×“ ×©×¢×•×ª - ×ª×™×§×•×Ÿ × ×¨××•×ª */
.time-separator { border-bottom: 1px dashed var(--border-color); margin: 6px 0; }
body.light-mode .time-separator { border-color: #94a3b8; opacity: 1; } /* ×‘×•×œ×˜ ×‘×‘×”×™×¨ */

/* ×›×¤×ª×•×¨×™× ×¤× ×™××™×™× */
.save-btn {
  background: var(--accent-green);
  color: #000000 !important; /* ×”×›×¨×—×ª ×˜×§×¡×˜ ×œ×‘×Ÿ ×œ×§×¨×™××•×ª ××§×¡×™××œ×™×ª */
  padding: 10px;
  border: none;
  border-radius: 6px;
  width: 100%;
  font-weight: bold;
  margin-top: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 1.1em;
}

/* ××¤×§×˜ ××¢×‘×¨ ×¢×“×™×Ÿ */
.save-btn:hover {
  filter: brightness(1.1);
}
.reset-btn { background: transparent; border:1px solid var(--accent-red); color: var(--accent-red); padding:8px; border-radius:6px; width:100%; margin-top:5px; cursor: pointer; }
.manual-slot-box { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05); }

button.del-btn { background: rgba(239, 68, 68, 0.1); color: var(--accent-red); border: 1px solid var(--accent-red); padding: 4px 8px; border-radius: 4px; font-size: 0.85em; cursor: pointer; }
button.del-free-slot-btn { background: transparent; color: var(--text-muted); border: 1px solid var(--text-muted); padding: 4px 8px; border-radius: 4px; font-size: 0.85em; cursor: pointer; }
button.restore-btn { background: rgba(16, 185, 129, 0.1); color: var(--accent-green); border: 1px solid var(--accent-green); padding: 4px 8px; border-radius: 4px; font-size: 0.85em; cursor: pointer; }

/* ××•×“×œ×™× */
#waModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; }
.wa-modal-content { background: var(--bg-panel); padding: 20px; border-radius: 10px; text-align: center; width: 300px; border: 1px solid var(--border-color); color: var(--text-main); }
#loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-body); z-index:9999; color: var(--text-main); display: flex; justify-content: center; align-items: center; flex-direction: column; }

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #64748b; border-radius: 3px; }

/* ==========================================
×ª×™×§×•×Ÿ ×¡×•×¤×™ ×œ× ×™×™×“: ××™×¨×›×•×– + ×¡×“×¨ ××¢×•×“×›×Ÿ
========================================== */
@media (max-width: 900px) {
  
  /* ××™×¤×•×¡×™× ×œ×× ×™×¢×ª ×ª×§×œ×•×ª ×’×œ×™×œ×” */
  body {
    overflow-y: auto !important;
    overflow-x: hidden !important;
    height: auto !important;
    padding: 10px 0 !important;
    margin: 0 !important;
  }
  
  .top-header {
    flex-direction: column;
    height: auto;
    align-items: center;
    gap: 15px;
    width: 100%;
    box-sizing: border-box;
  }
}

/* ==========================================
×ª×™×§×•×Ÿ ×œ× ×™×™×“: ×¡×“×¨ ×××•×œ×¥ (×§×œ× ×“×¨ > ×”×’×“×¨×•×ª > ×ª×•×¨×™×)
========================================== */
@media (max-width: 1000px) {
  
  /* ××™×¤×•×¡×™× ×—×™×•× ×™×™× */
  body {
    overflow-y: auto !important;
    overflow-x: hidden !important;
    height: auto !important;
    padding: 10px 0 !important;
    margin: 0 !important;
  }
  
  .top-header {
    flex-direction: column;
    height: auto;
    align-items: center;
    gap: 15px;
    width: 100%;
  }
  
  /* ==========================================
  ×ª×™×§×•×Ÿ ×¡×“×¨ ×‘×˜×œ×¤×•×Ÿ: ×©×™××•×© ×‘×©××•×ª ID ×”× ×›×•× ×™×
  ========================================== */
  @media (max-width: 1000px) {
    
    /* 1. ×”×’×“×¨×ª ×”×§×•× ×˜×™×™× ×¨ ×”×¨××©×™ ×›-Flex */
    #main-container {
      display: flex !important;
      flex-direction: column !important;
      height: auto !important;
      align-items: center !important;
      gap: 20px;
      padding: 0;
      margin: 0;
      width: 100%;
    }
    
    /* 2. ×¢×™×¦×•×‘ ×”×¤× ×œ×™× */
    .panel {
      width: 98% !important;
      max-width: 500px;
      flex: none !important;
      margin: 0 auto !important;
      box-sizing: border-box;
    }
    
    /* 3. ×§×‘×™×¢×ª ×”×¡×“×¨ (Order) - ×¢× ×”×©××•×ª ×”× ×›×•× ×™× ×œ×§×•×‘×¥ ×©×œ×š */
    
    /* ×¨××©×•×Ÿ: ×œ×•×— ×©× ×” */
    #calendarPanel {
      order: 1 !important;
    }
    
    /* ×©× ×™: ×”×’×“×¨×•×ª (×–×” ×”×©× ×”× ×›×•×Ÿ ××¦×œ×š ×‘×§×•×‘×¥) */
    #configPanelWrapper, #configPanel {
      order: 2 !important;
    }
    
    /* ×©×œ×™×©×™: ×ª×•×¨×™× */
    #slotsWrapper {
      order: 3 !important;
      min-height: 500px;
    }
    
    /* ×ª×™×§×•× ×™× ×›×œ×œ×™×™× ×œ×˜×œ×¤×•×Ÿ */
    body {
      overflow-y: auto !important;
      overflow-x: hidden !important;
      height: auto !important;
      padding: 10px 0 !important;
    }
    
    .top-header {
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    input, select, button, .header-actions button {
      min-height: 45px;
    }
  }
  @media all and (display-mode: standalone), (display-mode: fullscreen), (display-mode: minimal-ui) {
    #installAppBtn {
      display: none !important;
    }
  }
}

/* ×©×•×¨×ª ×”×—×œ×” */
.apply-row {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

/* ×—×¦×™ ×¤× ×œ â€“ ×™××™× ×§×“×™××” */
.apply-days-box {
  flex: 1;
  display: flex;
  flex-direction: column;
}

/* ×—×¦×™ ×¤× ×œ â€“ ×›×¤×ª×•×¨ */
.apply-mode-btn {
  flex: 1;
  align-self: flex-end;
  height: 38px;               /* ×–×”×” ×œ-input */
  margin-top: 22px;           /* ×’×•×‘×” ×”-label */
  background: var(--bg-input);
  color: var(--text-main);
  border: 1px solid var(--accent-blue);
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}

/* ××¦×‘ ×¤×¢×™×œ (×× ×™×© ×œ×š JS ×©××•×¡×™×£ class) */
.apply-mode-btn.active {
  background: var(--accent-blue);
  color: #fff;
}
/* ===== ×”×™×¡×˜×•×¨×™×” ===== */

.history-slot {
  border-right: 4px solid transparent;
}

/* ×‘×•×¦×¢ */
.history-booked {
  border-right-color: #22c55e;
  background: rgba(34, 197, 94, 0.08);
}

/* ×‘×•×˜×œ ×¢"×™ ×œ×§×•×— */
.history-cancelled-client {
  border-right-color: #f97316;
  background: rgba(249, 115, 22, 0.08);
}

/* ×‘×•×˜×œ ×¢"×™ ×× ×”×œ */
.history-cancelled-admin {
  border-right-color: #ef4444;
  background: rgba(239, 68, 68, 0.08);
}
/* ===== ×”×™×¡×˜×•×¨×™×” ×§×•××¤×§×˜×™×ª ===== */

.history-slot {
  padding: 6px 10px;
  margin-bottom: 4px;
}

.history-compact {
  line-height: 1.25;
}

.history-line-1 {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.9em;
}

.history-line-2 {
  font-size: 0.8em;
  opacity: 0.85;
  margin-top: 2px;
}

.history-status {
  font-size: 0.8em;
  white-space: nowrap;
}

.fulfill-btn {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 1.5px solid #999;
  border-radius: 50%;
  margin: 0 6px;
  cursor: pointer;
  flex-shrink: 0;
}

.fulfill-btn.on {
  background: #4caf50;
  border-color: #4caf50;
}

@media (max-width: 600px) {
  .fulfill-btn {
    width: 12px;
    height: 12px;
    margin: 0 4px;
  }
}

.fulfill-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: 16px;
  padding: 0 6px;
  margin: 0 6px;
  font-size: 10px;
  font-weight: 600;
  border: 1px solid #bbb;
  border-radius: 4px;
  color: #777;
  background: transparent;
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
}

.fulfill-badge.on {
  background: #4caf50;
  border-color: #4caf50;
  color: #fff;
}

/* ×©×™× ×•×™ ×¦×‘×¢ ×¡×œ×•×˜ ×›×©×”×ª×•×¨ ××•××© */
/* ×¡×œ×•×˜ ××•××© */
.slot.booked.fulfilled {
  background: #f1fbf4;       /* ×™×¨×•×§ ×‘×”×™×¨ ×××•×“ */
  border-color: #4caf50;
  color: #1b5e20;            /* ×˜×§×¡×˜ ×›×”×” */
}
/* ×©× + ×˜×œ×¤×•×Ÿ ×‘×ª×•×š ×¡×œ×•×˜ ××•××© */
.slot.booked.fulfilled small,
.slot.booked.fulfilled strong {
  color: #1b5e20;
}

/* ×× ×™×© ×˜×§×¡×˜ ×¨×’×™×œ (span / div) */
.slot.booked.fulfilled div {
  color: #1b5e20;
}

/* ××•×‘×™×™×œ */
@media (max-width: 600px) {
  .fulfill-badge {
    height: 14px;
    padding: 0 5px;
    font-size: 9px;
    margin: 0 4px;
  }
}
.toggle-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: 18px;
  padding: 0 8px;
  font-size: 11px;
  font-weight: 600;
  border: 1px solid #bbb;
  border-radius: 4px;
  color: #666;
  background: transparent;
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
  margin-inline-start: 8px;
}

.toggle-badge.on {
  background: #4caf50;
  border-color: #4caf50;
  color: #fff;
}

.apply-row input {
  flex: 1;
}

#enableFulfillmentBtn {
  flex-shrink: 0;
  white-space: nowrap;
}
.triple-row {
  display: flex;
  gap: 8px;
  align-items: flex-end; /* ğŸ”¥ ×”×§×¡× */
}

.triple-col {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.triple-col label {
  height: 22px; /* ×’×•×‘×” label ××—×™×“ */
}

.apply-mode-btn {
  height: 38px; /* ×–×”×” ×œ-input */
  background: var(--bg-input);
  border: 1px solid var(--accent-blue);
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}
.apply-mode-btn {
  text-align: center;
}
  .day-settings-row {
  display: flex;
  gap: 8px;
  align-items: flex-end;
}

.field-col label {
  line-height: 1.4;
  margin-bottom: 6px;
}

.field-col input,
#enableFulfillmentBtn {
  height: 35px;
}

.field-col input,
/* --- ×”×’×“×¨×•×ª ××©×ª× ×™× (×‘×¨×™×¨×ª ××—×“×œ: ××¦×‘ ×›×”×”) --- */
:root {
  --bg-body: #0f172a;       /* ×›×—×•×œ ×œ×™×œ×” ×¢××•×§ */
  --bg-panel: #1e293b;      /* ×¤×× ×œ×™× ×›×”×™× */
  --bg-header: #1e293b;     /* ×¡×¨×’×œ ×¢×œ×™×•×Ÿ */
  --bg-input: #334155;      /* ××™× ×¤×•×˜×™× */
  --text-main: #f1f5f9;     /* ×˜×§×¡×˜ ×œ×‘×Ÿ */
  --text-muted: #94a3b8;    /* ×˜×§×¡×˜ ××¤×•×¨ */
  --border-color: rgba(255,255,255,0.1);
  
  --accent-blue: #3b82f6;
  --accent-green: #ffffff;
  --accent-red: #ef4444;
  --accent-gold: #f59e0b;
  
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
  --border-radius: 8px;
}

/* --- ×”×’×“×¨×•×ª ×œ××¦×‘ ×‘×”×™×¨ (Light Mode) --- */
body.light-mode {
  --bg-body: #f3f4f6;       /* ××¤×•×¨ ×‘×”×™×¨ ×××•×“ */
  --bg-panel: #ffffff;      /* ×œ×‘×Ÿ */
  --bg-header: #ffffff;     /* ×œ×‘×Ÿ */
  --bg-input: #ffffff;      /* ×œ×‘×Ÿ */
  --text-main: #111827;     /* ×©×—×•×¨ */
  --text-muted: #6b7280;    /* ××¤×•×¨ ×›×”×” */
  --border-color: #e5e7eb;  /* ××¤×•×¨ ×‘×”×™×¨ ×œ××¡×’×¨×•×ª */
  
  --accent-blue: #2563eb;
  --accent-green: #059669;
  --accent-red: #dc2626;
  --accent-gold: #d97706;
  
  --shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* --- ×¢×™×¦×•×‘ ×›×œ×œ×™ --- */
body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background-color: var(--bg-body);
  color: var(--text-main);
  margin: 0;
  overflow: hidden;
  height: 100vh;
  font-size: 13px;
  direction: rtl;
  transition: background-color 0.3s, color 0.3s;
}

/* --- ×›×¤×ª×•×¨ ××™××•×© ×ª×•×¨×™× --- */
.fulfillment-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;

  height: 36px;
  padding: 0 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;

  background: #475569;          /* ××¤×•×¨ â€“ ××¦×‘ ×›×‘×•×™ */
  border: 1px solid #64748b;
  color: #94a3b8;               /* ×¦×‘×¢ ×˜×§×¡×˜ ×›×‘×•×™ */
}

/* ××¦×‘ ××•×¤×¢×œ (×“×œ×§×ª ×”×›×¤×ª×•×¨) */
.fulfillment-btn.on {
  background: #2563eb;          /* ×›×—×•×œ â€“ ××¦×‘ ×¤×¢×™×œ */
  border-color: #2563eb;
  color: #4ade80;               /* ×¦×‘×¢ ×˜×§×¡×˜ ×™×¨×•×§ */
}

/* ××™×™×§×•×Ÿ */
.fulfillment-btn .power-icon {
  width: 18px;
  height: 18px;
  fill: currentColor;           /* ğŸ”¥ ×–×” ×”××¤×ª×—: ×”××™×™×§×•×Ÿ ×™×•×¨×© ××ª ×”×¦×‘×¢ ××”×›×¤×ª×•×¨ */
  flex-shrink: 0;
}

/* × ×¨××•×ª ×‘××•×‘×™×™×œ */
@media (max-width: 600px) {

  .fulfillment-btn {
    width: 100%;
    justify-content: flex-start;
  }
  
  .fulfillment-btn svg {
    width: 16px;                    /* ×”×§×˜× ×” ×©×œ ×”××™×™×§×•×Ÿ ×‘××•×‘×™×™×œ */
    height: 16px;
  }

  .fulfillment-btn span {
    white-space: nowrap;            /* ×œ× ×™×™×’×–×¨ ×˜×§×¡×˜ ×‘××•×‘×™×™×œ */
  }
}
/* --- ×ª×™×§×•×Ÿ ×œ×©×•×¨×ª ×›×¤×ª×•×¨ ××™××•×© ×ª×•×¨×™× (×©×ª×ª×¤×¨×¡ ×œ×¨×•×—×‘ ××œ×) --- */
/* --- ×¤×ª×¨×•×Ÿ ×¡×•×¤×™: ×”×©×•×•××ª ×’×‘×”×™× ××œ××” ×¢"×™ ×”×¡×¨×ª ××’×‘×œ×•×ª --- */

/* 1. ××‘× ×” ×”×©×•×¨×” */
.day-settings-row {
  display: grid !important;
  grid-template-columns: 2fr 1fr 1fr !important; 
  gap: 10px !important;
  width: 100% !important;
  align-items: flex-end !important; /* ×™×™×©×•×¨ ×ª×—×ª×•×Ÿ ××•×©×œ× */
  margin-top: 15px !important;
}

/* 2. ×”×©×•×•××ª ×”×’×‘×”×™× ×œ×©×•×¨×” ×©××¢×œ */
.day-settings-row #enableFulfillmentBtn,
.day-settings-row .fulfillment-btn,
.day-settings-row .field-col input {
  /* ×‘×™×˜×•×œ ×›×œ ×”×’×“×¨×ª ×’×•×‘×” ×§×•×“××ª */
  height: auto !important; 
  min-height: 0 !important;
  max-height: none !important;

  /* ×©×™××•×© ×‘×¤×“×™× ×’ ×–×”×” ×œ×©×“×•×ª ×”×©×¢×•×ª ×©××¢×œ×™×”× */
  padding: 8px !important; 
  font-size: 13px !important;
  line-height: normal !important;
  
  box-sizing: border-box !important;
  margin: 0 !important;
  width: 100% !important;
  text-align: center !important;
}

/* 3. ×›×¤×ª×•×¨ ×”××™××•×© - ×•×™×“×•× ××¨××” ×–×”×” ×œ×©×“×” ×§×œ×˜ */
#enableFulfillmentBtn, .fulfillment-btn {
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  border: 1px solid var(--border-color) !important;
  font-weight: bold !important;
  /* ×’×•×‘×” ×”×›×¤×ª×•×¨ ×—×™×™×‘ ×œ×”×™×•×ª ×–×”×” ×¤×™×–×™×ª ×œ××™× ×¤×•×˜ */
  min-height: 35px !important; 
}

/* 4. ×‘×™×˜×•×œ ×—×™×¦×™× */
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type=number] {
  -moz-appearance: textfield;
}

/* 5. ×ª×™×§×•×Ÿ ×œ×œ×™×™×‘×œ×™× */
.field-col label {
  margin-bottom: 4px !important;
  display: block !important;
  font-size: 12px !important;
}

/* 6. ×”×ª×××” ×œ××•×‘×™×™×œ - ×©××™×¨×” ×¢×œ ×¤×¨×•×¤×•×¨×¦×™×•×ª */
@media (max-width: 600px) {
  .day-settings-row {
    gap: 6px !important;
  }
  /* ×‘××•×‘×™×™×œ × ×—×–×™×¨ ××¢×˜ ×’×•×‘×” ×× ×–×” × ×¨××” ×“×—×•×¡ */
  .day-settings-row #enableFulfillmentBtn,
  .day-settings-row .field-col input {
    padding: 10px 5px !important;
  }
}
</style>

<style>
/* ==========================================================================
×ª×™×§×•×Ÿ ×›×¤×ª×•×¨ ×”×™×¡×˜×•×¨×™×” - ×‘×ª×’×™×ª × ×¤×¨×“×ª ×›×“×™ ×œ×¢×§×•×£ ×©×’×™××•×ª ×¡×•×’×¨×™×™× ×‘×§×•×‘×¥ ×”×¨××©×™
========================================================================== */
.action-btn.history-btn {
  padding: 6px 10px;
  font-size: 0.85em;
  border-radius: 999px;
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  color: var(--text-main);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

/* ××¦×‘ ×¤×¢×™×œ â€“ ×¢×™×¦×•×‘ ×‘×•×œ×˜ (×–×”×•×‘) ×¢× !important ×›×“×™ ×œ×•×•×“× ×“×¨×™×¡×” */
.header-actions .action-btn.history-btn.active,
button.history-btn.active {
  background-color: var(--accent-gold) !important;
  color: #000 !important;
  border-color: var(--accent-gold) !important;
  box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.35) !important;
  transform: scale(1.05);
}
</style>
</head>
<body>
<div id="adminBookingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
<div class="wa-modal-content" style="width: 320px; text-align: right; position: relative;">
<h3 style="margin-top: 0; text-align: center; color: var(--accent-blue);">×”×–×× ×ª ×ª×•×¨ ×™×“× ×™×ª</h3>

<div style="margin-bottom: 10px;">
<label>×©×¢×”:</label>
<input type="text" id="bookingTimeDisplay" disabled style="font-weight: bold; background: #333; color: white;">
</div>

<div style="margin-bottom: 10px;">
<label>×©× ×¤×¨×˜×™:</label>
<input type="text" id="bookFirstName" placeholder="×”×›× ×¡ ×©× ×¤×¨×˜×™" autocomplete="off">
</div>

<div style="margin-bottom: 10px;">
<label>×©× ××©×¤×—×”:</label>
<input type="text" id="bookLastName" placeholder="×”×›× ×¡ ×©× ××©×¤×—×”" autocomplete="off">
</div>

<div style="margin-bottom: 15px;">
<label>×˜×œ×¤×•×Ÿ:</label>
<input type="tel" id="bookPhone" placeholder="050-0000000" autocomplete="off">
</div>

<div style="display: flex; gap: 10px;">
<button onclick="submitAdminBooking()" style="flex: 1; background: var(--accent-green); color: black; border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer;">ğŸ’¾ ×”×–××Ÿ ×ª×•×¨</button>
<button onclick="closeBookingModal()" style="flex: 1; background: transparent; border: 1px solid var(--text-muted); color: var(--text-main); padding: 10px; border-radius: 6px; cursor: pointer;">×‘×™×˜×•×œ</button>
</div>

</div>
</div>
</div>
</div>

<div id="waModal">
<div class="wa-modal-content">
<h3 style="margin:0; color:#25D366;">×”×ª×•×¨ ×‘×•×˜×œ!</h3>
<p style="margin:10px 0;">×©×œ×— ×”×•×“×¢×” ×œ×œ×§×•×—:</p>
<button id="waModalBtn" style="background:#25D366; color:white; border:none; padding:10px; width:100%; border-radius:6px; cursor:pointer; font-weight:bold;">ğŸ’¬ ×¤×ª×— ×•×•××˜×¡××¤</button>
<button onclick="document.getElementById('waModal').style.display='none'" style="background:transparent; border:1px solid #ccc; color:var(--text-main); padding:5px; width:100%; margin-top:10px; border-radius:6px; cursor:pointer;">×¡×’×•×¨</button>
</div>
</div>

<div id="loadingOverlay">
<div class="spinner" style="border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid var(--accent-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
<div style="margin-top: 15px;">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
</div>
<style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>

<div class="top-header">
<div class="header-title">×××©×§ × ×™×”×•×œ ×ª×•×¨×™×</div>

<div class="header-actions">
<button id="fullscreenBtn" class="action-btn" onclick="toggleFullScreen()" title="××¡×š ××œ×" style="background: transparent; border: 1px solid #ff9800; padding: 5px;">
<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#75FBFD"><path d="M792-576v-120H672v-72h120q30 0 51 21.15T864-696v120h-72Zm-696 0v-120q0-30 21.15-51T168-768h120v72H168v120H96Zm576 384v-72h120v-120h72v120q0 30-21.15 51T792-192H672Zm-504 0q-30 0-51-21.15T96-264v-120h72v120h120v72H168Zm72-144v-288h480v288H240Zm72-72h336v-144H312v144Zm0 0v-144 144Z"/></svg>
</button>

<button id="installAppBtn" style="display: none;">â¬‡ï¸ ×”×ª×§×Ÿ ××ª ×”××¤×œ×™×§×¦×™×”</button>
<button class="action-btn btn-theme" onclick="toggleTheme()" id="themeBtn">â˜€ï¸ ×™×•×</button>
<button class="action-btn btn-print" onclick="openReportModal()">ğŸ–¨ï¸ ×”×“×¤×¡ ×“×•"×—</button>
<button class="action-btn btn-excel" onclick="exportExcelReport()">ğŸ“Š ×™×™×¦×•× ×œ××§×¡×œ</button>
<button class="action-btn" style="background: #ef4444;" onclick="logoutAdmin()">ğŸšª ×™×¦×™××”</button>

<button id="historyBtn" class="action-btn history-btn" onclick="toggleHistoryModeBtn()">ğŸ•˜</button>
</div>
</div>

<div id="main-container">
<div id="configPanelWrapper" class="panel">
<div id="configForm">
<h3>×”×’×“×¨×•×ª ×™×•×</h3>
<div style="display: flex; gap: 8px;">
<div style="flex:1"><label>×”×ª×—×œ×”:</label><input type="text" class="time-input" id="range1Start" placeholder="HH:MM" maxlength="5" data-next="range1End" oninput="autoFormatTime(this)"></div>
<div style="flex:1"><label>×¡×™×•×:</label><input type="text" class="time-input" id="range1End" placeholder="HH:MM" maxlength="5" oninput="autoFormatTime(this)"></div>
</div>
<div style="display: flex; gap: 8px;">



<div class="day-settings-row">

  <div class="field-col">
    <label>××©×š ×ª×•×¨ (×“×§'):</label>
    <input type="number"
           id="range1Interval"
           min="5"
           max="120"
           value="10">
  </div>

  <div class="field-col">
    <label>×§×™×‘×•×œ×ª ×ª×•×¨×™×:</label>
    <input type="number"
           id="maxSlots"
           min="1"
           max="20"
           value="1">
  </div>

  <div class="field-col">
    <label>&nbsp;</label>
<button type="button" id="enableFulfillmentBtn" class="fulfillment-btn" onclick="toggleEnableFulfillment()">
  <svg class="power-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px">
    <path d="M480.21-480q-15.21 0-25.71-10.35T444-516v-312q0-15.3 10.29-25.65Q464.58-864 479.79-864t25.71 10.35Q516-843.3 516-828v312q0 15.3-10.29 25.65Q495.42-480 480.21-480ZM480-144q-70 0-131.13-26.6-61.14-26.6-106.4-71.87-45.27-45.26-71.87-106.4Q144-410 144-480q0-58.57 20-113.79Q184-649 221-694q10-13 25-14.5t26 9.5q10 11 11 25.5t-7 25.5q-29.45 36-44.73 79Q216-526 216-480q0 110.31 76.78 187.16 76.78 76.84 187 76.84T667-292.84q77-76.85 77-187.16 0-47-16-89.5T683-649q-9-11-8-25.5t12-25.5q10-11 25-9t25.78 14.36Q776-649 796-594t20 114q0 70-26.6 131.13-26.6 61.14-71.87 106.4-45.26 45.27-106.4 71.87Q550-144 480-144Z"/>
  </svg>
  ××™××•×© ×ª×•×¨×™×
</button>



  </div>

</div>


</div>



<hr style="border-color: var(--border-color); opacity:0.3;">
<label>×”×¤×¡×§×•×ª:</label>
<div id="breaksContainer"></div>
<button onclick="addBreakRow()" style="width: 100%; margin-top: 5px; background: transparent; border: 1px dashed var(--text-muted); color: var(--text-muted); padding: 6px; cursor: pointer; border-radius: 6px;">+ ×”×•×¡×£ ×”×¤×¡×§×”</button>

<hr style="border-color: var(--border-color); opacity:0.3;">
<div class="manual-slot-box">
<label style="color: var(--accent-blue); margin-bottom: 4px;">×”×•×¡×¤×ª ×ª×•×¨ ×‘×•×“×“:</label>
<div class="manual-slot-row" style="display: flex; gap: 10px; align-items: center;">
<input type="text" class="time-input" id="manualSlotTime" placeholder="HH:MM" maxlength="5" oninput="autoFormatTime(this)" style="flex: 1; margin-bottom: 0;">
<button onclick="addManualSlotFromUI()" style="width: auto; background: var(--accent-green); border: none; color: white; border-radius: 4px; cursor: pointer; padding: 6px 12px; margin-top: 0;">â•</button>
</div>
</div>

<div class="apply-row">

<div class="apply-days-box">
<label for="daysToApply">×”×—×œ ×¢×œ (×™××™× ×§×“×™××”):</label>
<input
type="number"
id="daysToApply"
value="1"
min="1"
>
</div>

<button
type="button"
onclick="toggleApplyMode()"
id="applyModeBtn"
class="apply-mode-btn"
>
ğŸ“… ×”×—×œ×” ×œ×¤×™ ×ª××¨×™×›×™× × ×‘×—×¨×™×
</button>

</div>

<div
id="applyDatesHint"
style="
display: none;
margin-top: 6px;
font-size: 0.85em;
color: var(--accent-blue);
text-align: center;
">
××¦×‘ ×‘×—×™×¨×” ×¤×¢×™×œ â€“ ×œ×—×¥ ×¢×œ ×ª××¨×™×›×™× ×‘×œ×•×—
</div>

<button class="save-btn" onclick="saveDayConfig()">ğŸ’¾ ×©××•×¨ ×”×’×“×¨×•×ª</button>
<button class="reset-btn" onclick="resetSettings()">ğŸ”„ ××¤×¡ ×”×’×“×¨×•×ª</button>
</div>
</div>

<div id="calendarPanel" class="panel">
<div id="calendarHeader">
<button onclick="prevMonth()">â®</button>
<span id="monthYearDisplay"></span>
<button onclick="nextMonth()">â¯</button>
</div>
<div id="weekdays"><div>×</div><div>×‘</div><div>×’</div><div>×“</div><div>×”</div><div>×•</div><div>×©</div></div>
<div id="calendar"></div>

<div style="margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border-color);">
<h4 style="margin: 0 0 10px 0; color: var(--text-muted); text-align: center; font-size: 1em;">×”×’×“×¨×•×ª ××¢×¨×›×ª</h4>
<div style="margin-bottom: 10px;"><label style="font-size: 0.85em; display:block; margin-bottom:3px;">×›×•×ª×¨×ª ×œ×™×•××Ÿ:</label><input type="text" id="calendarTitleSetting" placeholder="×œ×“×•×’××”: ×ª×•×¨ ×œ××¡×¤×¨×”" style="width:100%; text-align:right;"></div>
<div style="margin-bottom: 5px;"><label style="font-size: 0.85em; display:block; margin-bottom:3px;">×©××™×¨×ª ×”×™×¡×˜×•×¨×™×” (×™××™×):</label><input type="number" id="historyDays" value="30" style="width:100%; text-align:center;"></div>
<button onclick="saveSystemSettings()" style="width: 100%; background:var(--accent-blue); border:none; padding:8px; color:white; border-radius:4px; cursor:pointer; font-weight:bold;">×©××•×¨ ×”×’×“×¨×•×ª ××¢×¨×›×ª</button>
</div>
</div>

<div id="slotsWrapper" class="panel">
<h3>×ª×•×¨×™×: <span id="selectedDateDisplay" style="color:var(--text-main);"></span></h3>
<div id="slotsContainer"></div>
</div>

<div id="reportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
<div class="wa-modal-content" style="width: 350px; text-align: right;">
<h3 style="margin-top: 0; text-align: center; color: var(--accent-blue);">×”×¤×§×ª ×“×•×—×•×ª</h3>

<div style="background: var(--bg-input); padding: 10px; border-radius: 6px; margin-bottom: 15px;">
<label style="font-weight: bold; margin-bottom: 5px;">1. ×“×•×— ×™×•××™ (×œ×™×•× ×©× ×‘×—×¨)</label>
<button onclick="printDailyReport(); closeReportModal();" style="width: 100%; background: var(--bg-panel); border: 1px solid var(--accent-blue); color: var(--text-main); padding: 8px; border-radius: 4px; cursor: pointer;">
ğŸ–¨ï¸ ×”×“×¤×¡ ×“×•×— ×œ×™×•× ×”× ×•×›×—×™
</button>
</div>

<div style="background: var(--bg-input); padding: 10px; border-radius: 6px;">
<label style="font-weight: bold; margin-bottom: 10px;">2. ×“×•×— ×œ×¤×™ ×˜×œ×¤×•×Ÿ ×•×˜×•×•×— ×ª××¨×™×›×™×</label>

<div style="margin-bottom: 8px;">
<span style="font-size: 0.9em;">××ª××¨×™×š:</span>
<input type="date" id="repStart" style="width: 100%;">
</div>

<div style="margin-bottom: 8px;">
<span style="font-size: 0.9em;">×¢×“ ×ª××¨×™×š:</span>
<input type="date" id="repEnd" style="width: 100%;">
</div>

<div style="margin-bottom: 10px;">
<span style="font-size: 0.9em;">××¡×¤×¨ ×˜×œ×¤×•×Ÿ:</span>
<input type="text" id="repPhone" autocomplete="off" placeholder="×”×–×Ÿ ××¡×¤×¨ ×œ×—×™×¤×•×©" style="width: 100%;">
</div>

<button onclick="printRangeReport()" style="width: 100%; background: var(--accent-gold); border: none; color: white; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold;">
ğŸ” ××ª×¨ ×•×”×“×¤×¡ ×ª×•×¨×™×
</button>
</div>

<button onclick="closeReportModal()" style="margin-top: 15px; background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); padding: 5px; width: 100%; border-radius: 6px; cursor: pointer;">×‘×™×˜×•×œ</button>
</div>
</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCMO0LaL5zuZsqr8j_ovuxi26eXXLaXAqA",
  authDomain: "myqueueapp-7494a.firebaseapp.com",
  databaseURL: "https://myqueueapp-7494a-default-rtdb.firebaseio.com",
  projectId: "myqueueapp-7494a",
  storageBucket: "myqueueapp-7494a.firebasestorage.app",
  messagingSenderId: "877049737454",
  appId: "1:877049737454:web:14dcb6aa5e242bd9c403ff",
  measurementId: "G-RHNLPSSJHK"
};

let db;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
} catch(e) { console.error(e); alert("×ª×§×œ×” ×‘×—×™×‘×•×¨ ×œ-Firebase"); }

/* ============================================================
×‘×“×™×§×ª ××‘×˜×—×” ×•×›× ×™×¡×” - ××•×ª×× ×œ-Netlify ×•×œ-Localhost
============================================================ */

// ×¨×©×™××ª ×× ×”×œ×™× - ×”×—×œ×£/×”×•×¡×£ ×›××Ÿ ××™×™×œ×™× ×œ×¤×™ ×”×¦×•×¨×š

// ×¨×©×™××ª ×”×× ×”×œ×™× ×”××•×¨×©×™×
const ADMIN_EMAILS = [
"alfa990@gmail.com",
// "new-admin@example.com"
];

// × ×ª×™×‘ ×™×—×¡×™ - ×”×“×¤×“×¤×Ÿ ×™××¦× ×œ×‘×“ ××ª ×”×§×•×‘×¥ ×©× ××¦× ×‘××•×ª×” ×ª×™×§×™×™×”
const ADMIN_LOGIN_URL = "admin-login.html";

// ×œ×•×’×™×§×” ×©×œ ×‘×“×™×§×ª ××—×•×‘×¨/×œ× ××—×•×‘×¨
if (typeof firebase !== 'undefined' && firebase.auth) {
  firebase.auth().onAuthStateChanged(function(user) {
    
    // ××§×¨×™× ×‘×”× ×¦×¨×™×š ×œ×–×¨×•×§ ××ª ×”××©×ª××© ×”×—×•×¦×”:
    
    // 1. ×× ×”××©×ª××© ×œ× ××—×•×‘×¨ ×‘×›×œ×œ
    if (!user) {
      window.location.href = ADMIN_LOGIN_URL;
      return;
    }
    
    // 2. ×× ×”××©×ª××© ××—×•×‘×¨, ××‘×œ ×”××™×™×œ ×©×œ×• ×œ× ×‘×¨×©×™××ª ×”×× ×”×œ×™×
    if (!ADMIN_EMAILS.includes(user.email)) {
      alert("×’×™×©×” × ×“×—×ª×”: ×”××™×™×œ ×©×œ×š ××™× ×• ××•×¨×©×” ×œ× ×™×”×•×œ.");
      // ×× ×ª×§ ××ª ×”××©×ª××© ×•×©×•×œ×— ××•×ª×• ×œ×“×£ ×”×›× ×™×¡×”
      firebase.auth().signOut().then(function() {
        window.location.href = ADMIN_LOGIN_URL;
      });
      return;
    }
    
    // ×× ×”×’×¢× ×• ×œ×¤×” - ×”××©×ª××© ××—×•×‘×¨ ×•××•×¨×©×”. ×”×›×œ ×ª×§×™×Ÿ.
    console.log("×× ×”×œ ××—×•×‘×¨:", user.email);
  });
} else {
  // ×¨×©×ª ×‘×™×˜×—×•×Ÿ: ×× ×¤×™×™×¨×‘×™×™×¡ ×œ× × ×˜×¢×Ÿ ××©×•× ××” - ×–×¨×•×§ ×œ×›× ×™×¡×”
  console.error("Firebase Auth missing");
  window.location.href = ADMIN_LOGIN_URL;
}

// --- ×”×•×¡×£ ××ª ×”×¤×•× ×§×¦×™×” ×”×–×• ×‘×ª×—×™×œ×ª ×”×¡×§×¨×™×¤×˜ (×œ××©×œ ×©×•×¨×” 320) ---
function addSmartFocus(element) {
  if (!element) return;
  
  element.addEventListener('focus', function() {
    // ×©××•×¨ ××ª ×”×¢×¨×š ×”××§×•×¨×™
    this.setAttribute('data-original-val', this.value);
    // ×¨×•×§×Ÿ ××ª ×”×©×“×” ×œ×”×§×œ×“×” ×—×“×©×”
    this.value = '';
  });
  
  element.addEventListener('blur', function() {
    // ×× ×œ× ×”×•×§×œ×“ ×›×œ×•×, ×©×—×–×¨ ××ª ×”×¢×¨×š ×”××§×•×¨×™
    if (this.value.trim() === '') {
      this.value = this.getAttribute('data-original-val') || '';
    }
  });
}

function toggleTheme() {
  const body = document.body;
  const btn = document.getElementById('themeBtn');
  body.classList.toggle('light-mode');
  
  if (body.classList.contains('light-mode')) {
    localStorage.setItem('theme', 'light');
    btn.innerHTML = 'ğŸŒ™ ×œ×™×œ×”';
  } else {
    localStorage.setItem('theme', 'dark');
    btn.innerHTML = 'â˜€ï¸ ×™×•×';
  }
}

window.addEventListener('DOMContentLoaded', () => {
  // ... (×§×•×“ ×§×™×™× ×©×œ Theme) ...
  const savedTheme = localStorage.getItem('theme');
  const btn = document.getElementById('themeBtn');
  if (savedTheme === 'light') {
    document.body.classList.add('light-mode');
    if(btn) btn.innerHTML = 'ğŸŒ™ ×œ×™×œ×”';
  }
  
  // --- ×”×•×¡×£ ××ª ×”×§×˜×¢ ×”×–×” ×›××Ÿ: ---
  // ×¨×©×™××ª ×”×©×“×•×ª ×©×‘×¨×¦×•× ×š ×œ×”×—×™×œ ×¢×œ×™×”× ××ª ×”×”×ª× ×”×’×•×ª
  const inputsToSmartFocus = [
  'range1Start',
  'range1End',
  'range1Interval',
  'maxSlots',
  'daysToApply',
  'manualSlotTime',
  'calendarTitleSetting',
  'historyDays'
  ];
  
  inputsToSmartFocus.forEach(id => {
    addSmartFocus(document.getElementById(id));
  });
  // -----------------------------
});

let globalData = {};
let selectedDate = null;
let currentMonthDate = new Date();
let historyMode = false;
let enableFulfillment = false;
let applyMode = false;                 // ××¦×‘ ×‘×—×™×¨×ª ×ª××¨×™×›×™× ×œ×”×—×œ×”
let selectedApplyDates = new Set();    // ×ª××¨×™×›×™× ×©× ×‘×—×¨×• ×œ×”×—×œ×”

function toggleHistoryModeBtn() {
  historyMode = !historyMode;
  
  const btn = document.getElementById("historyBtn");
  
  if (historyMode) {
    btn.classList.add("active");
    btn.innerHTML = "ğŸ“œ";   // â† ×›××Ÿ: ××¦×‘ ×”×™×¡×˜×•×¨×™×” ×¤×¢×™×œ
  } else {
    btn.classList.remove("active");
    btn.innerHTML = "ğŸ•˜";   // â† ×›××Ÿ: ××¦×‘ ×¨×’×™×œ
    
    // ×—×–×¨×” ××•×˜×•××˜×™×ª ×œ×”×™×•×
    const now = new Date();
    selectedDate = dateToKey(now);
    currentMonthDate = new Date();
  }
  
  buildCalendar();
  renderSlots(selectedDate);
}

function toggleApplyMode() {
  
  applyMode = !applyMode;
  
  const hint = document.getElementById("applyDatesHint");
  const btn  = document.getElementById("applyModeBtn");
  const daysInput = document.getElementById("daysToApply");
  
  if (applyMode) {
    
    if (hint) hint.style.display = "block";
    if (btn) {
      btn.style.background = "#3b82f6";
      btn.style.color = "#ffffff";
    }
    
    // ×”×©×‘×ª×ª ×”×—×œ×” ×¢×œ ×™××™× ×§×“×™××”
    if (daysInput) {
      daysInput.disabled = true;
      daysInput.style.opacity = "0.5";
    }
    
  } else {
    
    if (hint) hint.style.display = "none";
    if (btn) {
      btn.style.background = "";
      btn.style.color = "";
    }
    
    // × ×™×§×•×™ ×‘×—×™×¨×•×ª ×œ×•×’×™×•×ª
    selectedApplyDates.clear();
    
    // × ×™×§×•×™ ×¡×™××•× ×™× ×•×™×–×•××œ×™×™×
    document.querySelectorAll(".day.apply-selected").forEach(el => {
      el.classList.remove("apply-selected");
    });
    
    // ×”×—×–×¨×ª ×™××™× ×§×“×™××”
    if (daysInput) {
      daysInput.disabled = false;
      daysInput.style.opacity = "1";
    }
  }
}

function autoFormatTime(input) {
  // 1. × ×™×§×•×™ ×•×¤×™×¨××•×˜ ×‘×¡×™×¡×™
  let val = input.value.replace(/[^0-9]/g, '');
  if (val.length > 2) {
    val = val.substring(0, 2) + ':' + val.substring(2, 4);
  }
  
  // 2. ×‘×“×™×§×ª ×©×’×™××•×ª
  let isInvalid = false;
  
  // ×‘×“×™×§×ª ×©×¢×•×ª (×× ×”×•×§×œ×“×• 2 ×¡×¤×¨×•×ª)
  if (val.length >= 2) {
    const hh = parseInt(val.substring(0, 2));
    if (hh > 23) isInvalid = true;
  }
  
  // ×‘×“×™×§×ª ×“×§×•×ª (×× ×”×•×§×œ×“×• 5 ×ª×•×•×™×)
  if (val.length === 5) {
    const mm = parseInt(val.substring(3, 5));
    if (mm > 59) isInvalid = true;
  }
  
  // 3. ×˜×™×¤×•×œ ×‘×ª×¦×•×’×”
  if (isInvalid) {
    // ×˜×¢×•×ª ×§×¨×™×˜×™×ª: ×¨×•×§×Ÿ ×©×“×” + ×”×¤×¢×œ ××¦×‘ "×©×’×™××”" (××“×•×)
    input.value = '';
    input.style.borderColor = '#ff4444';
    input.style.backgroundColor = 'rgba(255, 68, 68, 0.1)';
    input.style.boxShadow = '0 0 8px rgba(255, 68, 68, 0.4)';
  } else {
    // ×”××¦×‘ ×ª×§×™×Ÿ ×‘×™× ×ª×™×™×: ×¢×“×›×Ÿ ××ª ×”×¢×¨×š ×‘×©×“×”
    input.value = val;
    
    // ××ª×™ ××›×‘×™× ××ª ×”××“×•×?
    // ×¨×§ ×›×©×™×© ×©×¢×” ××œ××” (5 ×ª×•×•×™×) ××• ×›×©×”×©×“×” ×¨×™×§ ×œ×’××¨×™ (××™×¤×•×¡)
    // ××—×¨×ª (×œ××©×œ ×›×©×™×© 3 ×ª×•×•×™×), ×”××“×•× × ×©××¨ ×× ×”×•× ×›×‘×¨ ×“×•×œ×§
    if (val.length === 5 || val.length === 0) {
      input.style.borderColor = '';
      input.style.backgroundColor = '';
      input.style.boxShadow = '';
    }
    
    // 4. ××¢×‘×¨ ×©×“×” ××•×˜×•××˜×™ (×¨×§ ×‘×¡×™×•× ××•×¦×œ×—)
    if (val.length === 5) {
      const form = input.form || document.body;
      const focusable = Array.from(document.querySelectorAll('input:not([type="hidden"]), select, textarea, button'));
      const index = focusable.indexOf(input);
      if (index > -1 && index < focusable.length - 1) {
        focusable[index + 1].focus();
      }
    }
  }
}

function isValidTime(t) { return /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(t); }
function dateToKey(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function timeToMinutes(t){ if (!t) return -1; const p = t.split(":").map(Number); return p[0]*60 + p[1]; }
function minutesToTime(x){ return String(Math.floor(x/60)).padStart(2,"0")+":"+String(x%60).padStart(2,"0"); }

function generateSlotsWithBreaks(start, end, interval, breaks = []) {
  const out = [];
  let t = timeToMinutes(start);
  let endMin = timeToMinutes(end); // ×”××¨×ª ×©×¢×ª ×¡×™×•× ×œ×“×§×•×ª
  const step = Number(interval);
  
  // --- ×”×ª×™×§×•×Ÿ: ×˜×™×¤×•×œ ×‘×—×¦×•×ª (00:00) ×›×©×¢×ª ×¡×™×•× ---
  // ×× ×©×¢×ª ×”×¡×™×•× ×”×™× 0 (00:00) ×•×©×¢×ª ×”×”×ª×—×œ×” ×’×“×•×œ×” ×-0,
  // × ×ª×™×™×—×¡ ×œ×©×¢×ª ×”×¡×™×•× ×›-24:00 (1440 ×“×§×•×ª)
  if (endMin === 0 && t > 0) {
    endMin = 1440;
  }
  // ---------------------------------------------
  
  if (t === -1 || endMin === -1 || !step || step <= 0 || t > endMin) return [];
  
  // ××™×¤×•×™ ×•××™×•×Ÿ ×”×¤×¡×§×•×ª (×‘×“×§×•×ª)
  const brs = (breaks || [])
  .map(b => ({ start: timeToMinutes(b.start), end: timeToMinutes(b.end) }))
  .filter(b => b.start !== -1 && b.end !== -1 && b.end > b.start)
  .sort((a,b) => a.start - b.start);
  
  while (t < endMin) { // ×©×™× ×œ×‘: ×©×™× ×™×ª×™ ×œ- < ×‘××§×•× <= ×›×“×™ ×œ× ×œ×™×¦×•×¨ ×ª×•×¨ ×‘×•×œ ×‘-00:00 ×©×œ ××—×¨
  
  // ----------------------------------------------------
  // **×©×™× ×•×™ ×œ×¤×™ ×“×¨×™×©×”: ×”×ª×•×¨ ×”×¨××©×•×Ÿ ×œ××—×¨ ×”×¤×¡×§×” ××ª×—×™×œ ××™×“**
  // ----------------------------------------------------
  const inBr = brs.find(b => t >= b.start && t < b.end);
  if (inBr) {
    t = inBr.end; // ×“×œ×’ ×œ×¡×•×£ ×”×”×¤×¡×§×”
    
    // ×‘×“×™×§×”: ×”×× ×”×“×™×œ×•×’ ×”×—×“×© ×¢×“×™×™×Ÿ ×œ×¤× ×™ ×©×¢×ª ×”×¡×™×•×?
    // ×× ×›×Ÿ, ×× ×• ×“×•×—×¤×™× ×ª×•×¨ ×©××ª×—×™×œ *×‘×“×™×•×§* ×‘×¡×™×•× ×”×”×¤×¡×§×” (inBr.end)
    if (t + step <= endMin) {
      out.push(minutesToTime(t));
      t += step; // ××ª×§×“× ×œ××™× ×˜×¨×•×•×œ ×”×‘×, ×•×—×•×–×¨ ×œ×œ×•×œ××”
      continue; // ×××©×™×š ×œ×œ×•×œ××” ×”×‘××” (×œ× ×¨×•×¦×™× ×œ×”×¤×¢×™×œ ××ª ×§×˜×¢ ×”"×“×—×™×¤×”" ×”×¨×’×™×œ)
    }
    
    continue; // ×× ××™×Ÿ ××§×•× ×œ×ª×•×¨ ××œ×, ×¨×§ ××“×œ×’
  }
  // ----------------------------------------------------
  
  // ×”××¨×” ×—×–×¨×” ×œ×©×¢×” (×œ××©×œ 1440 -> 00:00 ×–×” ×œ× ×¨×œ×•×•× ×˜×™ ×›××Ÿ ×›×™ ×–×” ×”×¡×•×£)
  // ××‘×œ ×—×©×•×‘ ×œ×•×•×“× ×©×œ× ×—×•×¨×’×™×
  if (t + step <= endMin) {
    out.push(minutesToTime(t));
  }
  
  t += step;
}

return out;
}

function removeManualSlot(dateKey, time) {
  if(!confirm("×œ××—×•×§ ××ª ×”×ª×•×¨ ×”× ×•×¡×£ ×”×–×”?")) return;
  db.ref(`appointments/${dateKey}/appointments`).once('value', s => {
    let list = s.val() || [];
    const idx = list.findIndex(a => a.time === time && a.status === 'MANUAL');
    if (idx > -1) {
      list.splice(idx, 1);
      db.ref(`appointments/${dateKey}/appointments`).set(list);
    }
  });
}

function renderSlots(dateKey) {

  const daySettings = globalData[dateKey]?.settings || {};
  enableFulfillment = daySettings.enableFulfillment === true;

  const btn = document.getElementById('enableFulfillmentBtn');
  if (btn) {
    btn.classList.toggle('on', enableFulfillment);
  }

  if (!dateKey) dateKey = dateToKey(new Date());
  selectedDate = dateKey;
  document.getElementById("selectedDateDisplay").innerText = dateKey;

  const today = new Date(new Date().toDateString());
  const dateToCheck = new Date(dateKey);
  
  // ×¡×™××•×Ÿ ×”×™×•× ×‘×œ×•×—
  document.querySelectorAll('.day').forEach(d => d.classList.remove('selected-day'));
  document.querySelector(`[data-date="${selectedDate}"]`)?.classList.add('selected-day');
  
  const slotsDiv = document.getElementById("slotsContainer");
  slotsDiv.innerHTML = '';
  
  const day = globalData[dateKey] || {};
  const isPast = dateToCheck < today;
  const configForm = document.getElementById("configForm");
  
  // ××™×œ×•×™ ×˜×•×¤×¡ ×”×”×’×“×¨×•×ª ×× ×–×” ×œ× ×¢×‘×¨
  if (configForm && !isPast) {
    const s = day.settings || {};
    document.getElementById('range1Start').value = s.range1Start || "";
    document.getElementById('range1End').value = s.range1End || "";
    document.getElementById('range1Interval').value = s.range1Interval || "10";
    document.getElementById('maxSlots').value = s.maxSlots || "1";
    renderBreaksConfig(s.breaks || []);
  }
  
  // ×× ×¢×‘×¨ ×•×œ× ×‘××¦×‘ ×”×™×¡×˜×•×¨×™×”: ×ª×¦×•×’×ª ××¨×›×™×•×Ÿ
  if (isPast && !historyMode) {
    slotsDiv.innerHTML = `
    <div style="text-align:center; padding:20px; color:var(--text-muted);">
    <h3>××¨×›×™×•×Ÿ: ${dateKey}</h3>
    <p>×›×“×™ ×œ×¦×¤×•×ª, ×”×¤×¢×œ ××ª "×”×¦×’ ×”×™×¡×˜×•×¨×™×”".</p>
    </div>`;
    return;
  }
  
  const s = day.settings || {};
  const globalCapacity = parseInt(s.maxSlots) || 1;
  
  // ×›×œ ×”×¤×¢×™×œ×•×ª (×”×•×–××Ÿ/××‘×•×˜×œ/×™×“× ×™/×—×¡×•×)
  const activeAppointments = day.appointments || [];
  
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â­â­â­ ××¦×‘ ×”×™×¡×˜×•×¨×™×” â€” ××¦×™×’ ×¨×§ ××” ×©×‘×××ª ×§×¨×” â­â­â­
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  if (historyMode && isPast) {
    
    const historicAppointments = activeAppointments.filter(a =>
    a.time &&
    (
    a.status === 'BOOKED' ||
    a.status === 'CANCELLED' ||
    a.status === 'CANCELLED_BY_ADMIN'
    )
    );
    
    slotsDiv.innerHTML = "";
    
    if (historicAppointments.length === 0) {
      slotsDiv.innerHTML = `
      <div style="text-align:center; padding:20px; color:var(--text-muted);">
      <p>×œ× ×”×™×• ×ª×•×¨×™× ×‘×™×•× ×–×”</p>
      </div>`;
      return;
    }
    
    historicAppointments
    .sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time))
    .forEach(a => {
      
      const div = document.createElement("div");
      div.className = "slot history-slot";
      
      let statusText = "";
      let statusClass = "";
      
      switch (a.status) {

case 'BOOKED':
  if (a.fulfilled === true) {
    statusText = "âœ” ×‘×•×¦×¢";
    statusClass = "history-booked";
  } else {
    statusText = "×”×•×–××Ÿ";
    statusClass = "history-booked";
  }
  break;

        
        case 'CANCELLED':
        statusText = "âŒ ×‘×•×˜×œ ×¢×´×™ ×œ×§×•×—";
        statusClass = "history-cancelled-client";
        break;
        
        case 'CANCELLED_BY_ADMIN':
        statusText = "ğŸ› ï¸ ×‘×•×˜×œ ×¢×´×™ ×× ×”×œ";
        statusClass = "history-cancelled-admin";
        break;
      }
      
      div.classList.add(statusClass);
      
      div.innerHTML = `
      <div class="history-compact">
      
      <div class="history-line-1">
      <strong>${a.time}</strong>
      <span class="history-status">${statusText}</span>
      </div>
      
      ${
        a.first || a.last || a.phone
        ? `<div class="history-line-2">
        ${a.first || ''} ${a.last || ''}
        ${a.phone ? `Â· ${a.phone}` : ''}
        </div>`
        : ''
      }
      
      </div>
      
      ${
        a.phone
        ? `<div style="font-size:0.8em; opacity:0.8;">
        ğŸ“ ${a.phone}
        </div>`
        : ''
      }
      </div>
      `;
      
      slotsDiv.appendChild(div);
    });
    
    return;
  }
  
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â­â­â­ ××›××Ÿ ×•×”×œ××” â€” ××¦×‘ ×¨×’×™×œ ×‘×œ×‘×“ â­â­â­
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  */
  
  // ×™×¦×™×¨×ª ×ª×•×¨×™× ×‘×¡×™×¡×™×™× ×¢× ×”×¤×¡×§×•×ª
  let base = (s.range1Start && s.range1End)
  ? generateSlotsWithBreaks(s.range1Start, s.range1End, s.range1Interval, s.breaks || [])
  : [];
  
  const allActivityTimes = activeAppointments.map(a => a.time);
  const combined = [...new Set([...base, ...allActivityTimes])].sort();
  
  if (combined.length === 0) {
    slotsDiv.innerHTML = `
    <p style="text-align:center; color:var(--text-muted); margin-top:20px;">
    ××™×Ÿ ×ª×•×¨×™×.
    </p>`;
    return;
  }
  
  const isToday = (dateKey === dateToKey(new Date()));
  const currentMinutes = new Date().getHours() * 60 + new Date().getMinutes();
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ×ª×™×§×•×Ÿ ×—×“×©: ×—×™×©×•×‘ "×¡×•×£ ×™×•× ××¤×§×˜×™×‘×™" (×–×™×”×•×™ ×—×¡×™××•×ª ×‘×¡×•×£)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let effectiveEndIndex = combined.length;
  
  // ×¨×¦×™× ××—×•×¨×” ×›×“×™ ×œ××¦×•× ×¨×¦×£ ×—×¡×™××•×ª
  for (let i = combined.length - 1; i >= 0; i--) {
    const t = combined[i];
    // ×‘×“×™×§×” ×× ×”×ª×•×¨ ×—×¡×•× (DELETED ××• BLOCKED)
    const isBlocked = activeAppointments.some(a => a.time === t && (a.status === 'DELETED' || a.status === 'BLOCKED'));
    
    if (isBlocked) {
      effectiveEndIndex = i; // ×¡×•×£ ×”×™×•× ×–×– ××—×•×¨×”
    } else {
      break; // ×‘×¨×’×¢ ×©×¤×•×’×©×™× ×ª×•×¨ ×œ× ×—×¡×•×, ×¢×•×¦×¨×™×
    }
  }
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ×œ×•×œ××” ×¢×œ ×›×œ ×”×ª×•×¨×™×
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  combined.forEach((time, index) => {
    
    // ğŸŸ¢ ×ª×™×§×•×Ÿ ×—×“×©: ×”×¦×’×ª ×¡×™××Ÿ ×¡×•×£ ×™×•× ××•×§×“× ×× ×”×’×¢× ×• ×œ× ×§×•×“×ª ×”×—×¡×™××”
    if (index === effectiveEndIndex) {
      const separator = document.createElement("div");
      separator.className = "break-separator";
      separator.style.cssText = "border-color: var(--accent-red); color: var(--accent-red); background: rgba(239, 68, 68, 0.05); margin-top: 12px;";
      separator.textContent = `-------- ×¡×•×£ ×™×•× (${time}) - ×™×•× ××§×•×¦×¨ --------`;
      slotsDiv.appendChild(separator);
    }
    
    const tMin = timeToMinutes(time);
    const prevTime = index > 0 ? combined[index - 1] : null;
    
    // ×”×¤×¡×§×•×ª ××•×’×“×¨×•×ª
    if (prevTime) {
      const prevMin = timeToMinutes(prevTime);
      if (s.breaks) s.breaks.forEach(br => {
        const bs = timeToMinutes(br.start), be = timeToMinutes(br.end);
        if (prevMin < bs && tMin >= be) {
          slotsDiv.innerHTML += `
          <div class="break-separator">
          â˜• ×”×¤×¡×§×” (${br.start} - ${br.end})
          </div>`;
        }
      });
    }
    
    // ×ª×•×¡×¤×•×ª ××›×¡×” (×ª×•×¨×™× ×™×“× ×™×™×)
    const extrasHere = activeAppointments.filter(a =>
    a.time === time && a.status === 'EXTRA_CAPACITY'
    ).length;
    
    const baseCap = base.includes(time) ? globalCapacity : 0;
    const totalCapacity = baseCap + extrasHere;
    
    if (totalCapacity === 0 && !activeAppointments.some(a => a.time === time)) return;
    
    // ×“×™×œ×•×’ ×¢×œ ×¢×‘×¨ ×©×œ ×”×™×•× ×”× ×•×›×—×™
    if (isToday && tMin < currentMinutes) {
      const hasActive = activeAppointments.some(x =>
      x.time === time &&
      x.status !== 'DELETED' &&
      x.status !== 'EXTRA_CAPACITY'
      );
      if (!hasActive) return;
    }
    
    // ×ª×•×¡×¤×ª ××›×¡×” â€” ×”×¦×’×”
    if (extrasHere > 0) {
      slotsDiv.innerHTML += `
      <div class="slot" style="border:1px dashed var(--text-muted); padding:5px;">
      <div style="font-size:0.9em; color:var(--text-muted);">
      â• ×ª×•×¡×¤×ª ××›×¡×” (${extrasHere}) ×œ×©×¢×” ${time}
      </div>
      ${!isPast ? `<button class="del-btn" onclick="removeExtraSlot('${dateKey}', '${time}')">×‘×˜×œ ×ª×•×¡×¤×ª</button>` : ''}
      </div>`;
    }
    
    // ×ª×•×¨×™× ××•×–×× ×™×
    const bookings = activeAppointments.filter(x =>
    x.time === time && x.phone && x.status !== 'DELETED'
    );
    
bookings.forEach(appt => {

  const fulfilledClass = appt.fulfilled ? 'fulfilled' : '';

  slotsDiv.innerHTML += `
  <div class="slot booked ${fulfilledClass}">
    <div>
      <strong>${time}</strong> â€” ${appt.first} ${appt.last}
      <br><small>ğŸ“ ${appt.phone}</small>

      ${
        enableFulfillment
          ? `<span
               class="fulfill-badge ${appt.fulfilled ? 'on' : ''}"
               onclick="toggleFulfilled('${dateKey}', '${time}', '${appt.phone}', ${!appt.fulfilled})">
               ××•××©
             </span>`
          : ''
      }
    </div>

    ${!isPast
      ? `<button class="del-btn"
          onclick="adminCancel('${dateKey}', '${time}', '${appt.phone}')">âŒ ×‘×˜×œ</button>`
      : ''
    }
  </div>`;
});


    
    // ×—×¡×•××™×
    const blocked = activeAppointments.filter(x =>
    x.time === time && x.status === 'DELETED'
    );
    
    blocked.forEach(blk => {
      slotsDiv.innerHTML += `
      <div class="slot blocked">
      <div style="text-decoration:line-through;"><strong>${time}</strong> â€” ×—×¡×•×</div>
      ${!isPast ? `<button class="restore-btn" onclick="restoreSlot('${dateKey}', '${time}')">×©×—×–×¨</button>` : ''}
      </div>`;
    });
    
    // ×—×™×©×•×‘ ×¤× ×•×™×™×
    const used = bookings.length + blocked.length;
    const remaining = totalCapacity - used;
    
    // ×ª×•×¨×™× ×¤× ×•×™×™×
    if (remaining > 0 && (!isToday || tMin > currentMinutes)) {
      for (let i = 0; i < remaining; i++) {
        const countText = totalCapacity > 1 ? ` (${i + 1})` : '';
        
        slotsDiv.innerHTML += `
        <div class="slot free" onclick="openBookingWindow('${time}')" style="cursor: pointer;" title="×œ×—×¥ ×œ×”×–×× ×ª ×ª×•×¨">
        <div>
        <div style="font-weight:bold;">${time}</div>
        <div style="font-size:0.85em; opacity:0.8;">×¤× ×•×™ - ×œ×—×¥ ×œ×”×–×× ×” ${countText}</div>
        </div>
        
        <div style="z-index: 10;">
        ${!isPast ? `
        <button class="del-free-slot-btn"
        onclick="event.stopPropagation(); blockFreeSlot('${dateKey}', '${time}')"
        title="×—×¡×•× ×ª×•×¨ ×–×”">
        âŒ
        </button>` : ''}
        </div>
        </div>`;
      }
    }
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ×”×¤×¡×§×” ×‘×™×Ÿ ×¡×•×£ ×™×•× ×œ×ª×•×¨ ×™×“× ×™
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const nextTime = combined[index + 1];
    const nextMin = nextTime ? timeToMinutes(nextTime) : null;
    const endOfDayMin = timeToMinutes(s.range1End);
    
    const isNextManual = activeAppointments.some(
    a => a.time === nextTime && a.status === 'EXTRA_CAPACITY'
    );
    
    if (tMin < endOfDayMin && nextMin > endOfDayMin && isNextManual) {
      slotsDiv.innerHTML += `
      <div class="break-separator">
      â¸ï¸ ×”×¤×¡×§×” (${s.range1End} - ${nextTime})
      </div>`;
    } else {
      if (index < combined.length - 1) {
        slotsDiv.innerHTML += `<div class="time-separator"></div>`;
      }
    }
    
  });
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ×¡×•×£ ×™×•× (×¨×’×™×œ) - ×™×•×¦×’ ×¨×§ ×× *×œ×* ×”×™×” ×§×™×¦×•×¨ ×™×•×
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸŸ¢ ×ª×™×§×•×Ÿ ×—×“×©: ×”×ª× ××™ effectiveEndIndex === combined.length
  if (combined.length > 0 && effectiveEndIndex === combined.length) {
    const lastTime = combined[combined.length - 1];
    const interval = parseInt(s.range1Interval) || 10;
    const lastMins = timeToMinutes(lastTime);
    const endMins = lastMins + interval;
    
    const endHour = String(Math.floor(endMins / 60)).padStart(2, '0');
    const endMin = String(endMins % 60).padStart(2, '0');
    
    const finalEnd = `${endHour}:${endMin}`;
    
    const div = document.createElement("div");
    div.className = "break-separator end-of-day";
    div.style.marginTop = "12px";
    div.textContent = `-------- ×¡×•×£ ×™×•× (${finalEnd}) --------`;
    slotsDiv.appendChild(div);
  }
}

function addManualSlotFromUI() {
  const time = document.getElementById("manualSlotTime").value;
  if (!isValidTime(time) || !selectedDate) return alert("×‘×“×•×§ ×ª××¨×™×š ×•×©×¢×”");
  updateAppt(selectedDate, { time: time, status: 'EXTRA_CAPACITY' });
  document.getElementById("manualSlotTime").value = "";
}

/* =====================================================
×¤×•× ×§×¦×™×” ×œ××™×¤×•×¡ ×”×’×“×¨×•×ª (×™××™× ×§×“×™××” / ×ª××¨×™×›×™× × ×‘×—×¨×™×)
===================================================== */
async function resetSettings() {
  
  if (!selectedDate) {
    alert("×‘×—×¨ ×ª××¨×™×š ×ª×—×™×œ×”");
    return;
  }
  
  let datesToReset = [];
  
  /* ===== ×§×‘×™×¢×ª ×ª××¨×™×›×™× ×œ××™×¤×•×¡ ===== */
  
  if (applyMode && selectedApplyDates.size > 0) {
    // ğŸ”µ ××™×¤×•×¡ ×œ×¤×™ ×ª××¨×™×›×™× × ×‘×—×¨×™×
    datesToReset = Array.from(selectedApplyDates);
    
  } else {
    // ğŸŸ¢ ××™×¤×•×¡ ×¨×’×™×œ â€“ ×™××™× ×§×“×™××”
    const daysInput = document.getElementById("daysToApply");
    const days = daysInput ? (parseInt(daysInput.value) || 1) : 1;
    
    const start = new Date(selectedDate);
    
    for (let i = 0; i < days; i++) {
      const d = new Date(start);
      d.setDate(start.getDate() + i);
      datesToReset.push(dateToKey(d));
    }
  }
  
  if (datesToReset.length === 0) {
    alert("×œ× × ×‘×—×¨×• ×ª××¨×™×›×™× ×œ××™×¤×•×¡");
    return;
  }
  
  if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×”×’×“×¨×•×ª ×•×ª×•×¨×™× ×¤× ×•×™×™× ×œ-${datesToReset.length} ×ª××¨×™×›×™×?`)) {
    return;
  }
  
  const updates = {};
  
  /* ===== ×‘× ×™×™×ª ×¢×“×›×•× ×™× ===== */
  
  datesToReset.forEach(k => {
    
    const day = globalData[k];
    
    // ×©×•××¨×™× ×ª×•×¨×™× ×©×™×© ×œ×”× ×˜×œ×¤×•×Ÿ (×œ× ××•×—×§×™× ×”×–×× ×•×ª ×××™×ª×™×•×ª)
    const kept = (day && day.appointments)
    ? day.appointments.filter(a => a.phone && a.status !== 'DELETED')
    : null;
    
    updates[`appointments/${k}/settings`] = null;
    updates[`appointments/${k}/appointments`] = (kept && kept.length) ? kept : null;
    
    // ×¢×“×›×•×Ÿ ×–×™×›×¨×•×Ÿ ××§×•××™
    if (globalData[k]) {
      delete globalData[k].settings;
      globalData[k].appointments = kept && kept.length ? kept : null;
    }
  });
  
  if (typeof db === 'undefined') {
    alert("×©×’×™××” ×§×¨×™×˜×™×ª: ××™×Ÿ ×—×™×‘×•×¨ ×œ××¡×“ ×”× ×ª×•× ×™×.");
    return;
  }
  
  /* ===== ×‘×™×¦×•×¢ ×”××™×¤×•×¡ ===== */
  
  try {
    await db.ref().update(updates);
    
    alert("×”×”×’×“×¨×•×ª ××•×¤×¡×• ×‘×”×¦×œ×—×”!");
    
    // × ×™×§×•×™ ××¦×‘ ×”×—×œ×”
    applyMode = false;
    selectedApplyDates.clear();
    
    const daysInput = document.getElementById("daysToApply");
    if (daysInput) {
      daysInput.disabled = false;
      daysInput.style.opacity = "1";
    }
    
    const hint = document.getElementById("applyDatesHint");
    if (hint) hint.style.display = "none";
    
    buildCalendar();
    renderSlots(selectedDate);
    
  } catch (e) {
    alert("×©×’×™××” ×‘××™×¤×•×¡: " + e.message);
  }
}

function addBreakRow(s='', e='') {
  const div = document.createElement("div");
  div.className = "break-row";
  div.style.cssText = "display:flex; gap:5px; margin-bottom:5px;";
  
  // ×™×¦×™×¨×ª ×”-HTML ×”×¤× ×™××™ (×¢× ×”×ª×™×§×•×Ÿ ×©×œ ×”-tabindex ×œ×›×¤×ª×•×¨)
  div.innerHTML = `
  <input type="text" class="break-start time-input" placeholder="×”×ª×—×œ×”" value="${s}" maxlength="5" style="width:40%" oninput="autoFormatTime(this)">
  <span>-</span>
  <input type="text" class="break-end time-input" placeholder="×¡×™×•×" value="${e}" maxlength="5" style="width:40%" oninput="autoFormatTime(this)">
  <button tabindex="-1" onclick="this.parentElement.remove()" style="background:transparent; border:1px solid #dc3545; color:#dc3545; border-radius:4px; cursor:pointer;">x</button>
  `;
  
  document.getElementById("breaksContainer").appendChild(div);
  
  // --- × ×™×”×•×œ ×”×¤×•×§×•×¡ ×•×”××¢×‘×¨×™× ---
  
  // 1. ×”×’×“×¨×ª ×©×“×” ×”×ª×—×œ×” (×›×¨×’×™×œ)
  addSmartFocus(div.querySelector('.break-start'));
  
  // 2. ×”×’×“×¨×ª ×©×“×” ×¡×™×•×
  const endInput = div.querySelector('.break-end');
  
  // ×—×“×©: ×‘×¨×’×¢ ×©×”×¤×•×§×•×¡ ××’×™×¢ ×œ×©×“×” ×¡×™×•× (××©×“×” ×”×ª×—×œ×” ××• ×‘×œ×—×™×¦×”) - ×¡××Ÿ ××ª ×”×˜×§×¡×˜
  endInput.addEventListener('focus', function() {
    this.select();
  });
  
  // ×”×œ×•×’×™×§×” ×”×§×•×“××ª: ×‘×¡×™×•× ×”×§×œ×“×”, ×“×œ×’ ×œ×©×“×” "×™××™× ×§×“×™××”"
  endInput.addEventListener('input', function() {
    if (this.value.length === 5) {
      const daysInput = document.getElementById('daysToApply');
      if (daysInput) {
        daysInput.focus();
        daysInput.select();
      }
    }
  });
}
function renderBreaksConfig(breaks=[]) { document.getElementById("breaksContainer").innerHTML=''; breaks.forEach(b=>addBreakRow(b.start, b.end)); }

function adminCancel(dateKey, time, phoneToCancel) {

  const dayData = globalData[dateKey];
  let clientPhone = phoneToCancel || "";
  let clientName = "×œ×§×•×—";

  if (dayData && dayData.appointments) {
    const appt = dayData.appointments.find(
      a => a.time === time && a.phone === phoneToCancel
    );
    if (appt) clientName = appt.first || "×œ×§×•×—";
  }

  if (!confirm("×”×× ×œ×‘×˜×œ ××ª ×”×ª×•×¨ ×”×–×”?")) return;

  // ğŸ”´ ××—×™×§×” ×××™×ª×™×ª ×©×œ ×”×ª×•×¨ (×‘×œ×™ ×¡×˜×˜×•×¡, ×‘×œ×™ ×™×¦×™×¨×”)
  db.ref(`appointments/${dateKey}/appointments`).once('value', s => {
    let list = s.val() || [];

    list = list.filter(a =>
      !(a.time === time && a.phone === phoneToCancel)
    );

    db.ref(`appointments/${dateKey}/appointments`).set(list)
      .then(() => {
        // ×¢×“×›×•×Ÿ ××§×•××™ ×œ×× ×™×¢×ª ×¨×™× ×“×•×¨ ×›×¤×•×œ
        if (globalData[dateKey]) {
          globalData[dateKey].appointments = list;
        }
        renderSlots(dateKey);
      });
  });

  // --- ×©×œ×™×—×ª ×•×•××˜×¡××¤ (× ×©××¨ ×›××• ×©×”×™×”) ---
  if (clientPhone && clientPhone.length > 5) {
    let cleanPhone = clientPhone.replace(/\D/g, '');
    if (cleanPhone.startsWith('0')) cleanPhone = '972' + cleanPhone.substring(1);

    const titleElement = document.getElementById("calendarTitleSetting");
    const serviceName =
      (titleElement && titleElement.value) ? titleElement.value : "×”×¢×¡×§";

    const message =
      `${clientName} ×©×œ×•×,\n` +
      `×”×ª×•×¨ ×©× ×§×‘×¢ ×œ${serviceName} ×œ×ª××¨×™×š ${dateKey}, ×©×¢×” ${time} ×‘×•×˜×œ.\n` +
      `×”×™× ×š ××•×–××Ÿ ×œ×§×‘×•×¢ ×ª×•×¨ ×—×“×© ×‘×§×™×©×•×¨:\n` +
      `https://torimapp.netlify.app/`;

    const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
    const waBtn = document.getElementById("waModalBtn");

    waBtn.onclick = function () {
      window.open(url, '_blank');
      document.getElementById('waModal').style.display = 'none';
    };

    document.getElementById('waModal').style.display = 'flex';
  }
}

function toggleFulfilled(dateKey, time, phone, checked) {
  db.ref(`appointments/${dateKey}/appointments`).once('value', s => {
    const list = s.val() || [];

    const idx = list.findIndex(a =>
      a.time === time && a.phone === phone
    );

    if (idx === -1) return;

    list[idx].fulfilled = checked;

    db.ref(`appointments/${dateKey}/appointments`).set(list);
  });
}

// ×¤×•× ×§×¦×™×” ×œ×—×¡×™××ª ×ª×•×¨ ×¤× ×•×™ (×”×•×¤×›×ª ××•×ª×• ×œ-DELETED)
function blockFreeSlot(dateKey, time) {
  if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×—×¡×•× ××ª ×”×ª×•×¨ ×‘×©×¢×” ' + time + '?')) return;
  
  const ref = db.ref(`appointments/${dateKey}/appointments`);
  
  ref.once('value', snapshot => {
    let list = snapshot.val() || [];
    
    // ×”×•×¡×¤×ª ×¨×©×•××” ××¡×•×’ DELETED ×©×—×•×¡××ª ××ª ×”×©×¢×” ×”×–×•
    list.push({
      time: time,
      status: 'DELETED',
      timestamp: Date.now()
    });
    
    ref.set(list)
    .then(() => {
      // ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×” (××•×¤×¦×™×•× ×œ×™, ×”-Listener ×××•×¨ ×œ×¢×©×•×ª ×–××ª ××•×˜×•××˜×™×ª)
      console.log(`Slot ${time} blocked successfully`);
    })
    .catch(err => alert('×©×’×™××” ×‘×—×¡×™××ª ×”×ª×•×¨: ' + err.message));
  });
}

function deleteFreeSlot(k, t) { updateAppt(k, { time: t, status: "DELETED" }); }

function restoreSlot(k, t) {
  if(confirm("×œ×©×—×–×¨ ×¡×œ×•×˜ ××—×“?")) {
    db.ref(`appointments/${k}/appointments`).once('value', s => {
      let list = s.val() || [];
      const idx = list.findIndex(a => a.time === t && a.status === 'DELETED');
      if (idx > -1) {
        list.splice(idx, 1);
        db.ref(`appointments/${k}/appointments`).set(list);
      }
    });
  }
}

function updateAppt(k, newAppt) {
  db.ref(`appointments/${k}/appointments`).once('value', s => {
    let list = s.val() || [];
    list.push(newAppt);
    db.ref(`appointments/${k}/appointments`).set(list);
  });
}

function removeFromDb(k, t, phone) {
  db.ref(`appointments/${k}/appointments`).once('value', s => {
    let list = s.val() || [];
    list = list.filter(a => !(a.time === t && a.phone === phone));
    db.ref(`appointments/${k}/appointments`).set(list);
  });
}

function exportExcelReport() {
  if(!selectedDate) { alert("×™×© ×œ×‘×—×•×¨ ×™×•× ××”×œ×•×— ×ª×—×™×œ×”."); return; }
  const dayData = globalData[selectedDate];
  if(!dayData || !dayData.appointments) { alert("××™×Ÿ × ×ª×•× ×™× ×œ×™×•× ×–×”."); return; }
  const booked = dayData.appointments.filter(a => a.phone && a.status !== 'DELETED');
  booked.sort((a,b) => a.time.localeCompare(b.time));
  if(booked.length === 0) { alert("××™×Ÿ ×ª×•×¨×™× ××•×–×× ×™× ×‘×™×•× ×–×”."); return; }
  const data = booked.map((a, index) => ({ "××¡'": index + 1, "×©×¢×”": a.time, "×©× ×¤×¨×˜×™": a.first, "×©× ××©×¤×—×”": a.last, "×˜×œ×¤×•×Ÿ": a.phone }));
  const ws = XLSX.utils.json_to_sheet(data, { origin: "A3" });
  ws['!cols'] = [ { wch: 6 }, { wch: 10 }, { wch: 20 }, { wch: 20 }, { wch: 15 } ];
  
  const titleElement = document.getElementById("calendarTitleSetting");
  const mainTitle = (titleElement && titleElement.value) ? titleElement.value : "×“×•×— ×ª×•×¨×™×";
  const subTitle = `×ª××¨×™×š: ${selectedDate} | ×¡×”"×› ×ª×•×¨×™×: ${booked.length}`;
  XLSX.utils.sheet_add_aoa(ws, [[mainTitle]], { origin: "A1" });
  XLSX.utils.sheet_add_aoa(ws, [[subTitle]], { origin: "A2" });
  ws["!merges"] = [ { s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }, { s: { r: 1, c: 0 }, e: { r: 1, c: 4 } } ];
  
  const borderStyle = { top: { style: 'thin', color: { rgb: "000000" } }, bottom: { style: 'thin', color: { rgb: "000000" } }, left: { style: 'thin', color: { rgb: "000000" } }, right: { style: 'thin', color: { rgb: "000000" } } };
  const titleStyle = { font: { bold: true, sz: 20, color: { rgb: "000000" }, name: "Segoe UI" }, alignment: { horizontal: "center", vertical: "center" }, fill: { fgColor: { rgb: "FFFFFF" } } };
  const subTitleStyle = { font: { sz: 12, color: { rgb: "444444" }, name: "Segoe UI" }, alignment: { horizontal: "center", vertical: "center" }, fill: { fgColor: { rgb: "FFFFFF" } } };
  const headerStyle = { font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12, name: "Segoe UI" }, fill: { fgColor: { rgb: "4472C4" } }, border: borderStyle, alignment: { horizontal: "center", vertical: "center" } };
  const cellStyle = { border: borderStyle, alignment: { horizontal: "right", vertical: "center" }, font: { sz: 11, name: "Segoe UI" } };
  const centerCellStyle = { border: borderStyle, alignment: { horizontal: "center", vertical: "center" }, font: { sz: 11, name: "Segoe UI" } };
  
  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let R = range.s.r; R <= range.e.r; ++R) {
    for (let C = range.s.c; C <= range.e.c; ++C) {
      const cell_address = XLSX.utils.encode_cell({r: R, c: C});
      if (!ws[cell_address]) continue;
      if (R === 0) ws[cell_address].s = titleStyle;
      else if (R === 1) ws[cell_address].s = subTitleStyle;
      else if (R === 2) ws[cell_address].s = headerStyle;
      else { if (C === 0 || C === 1 || C === 4) ws[cell_address].s = centerCellStyle; else ws[cell_address].s = cellStyle; }
    }
  }
  
  const wb = XLSX.utils.book_new(); wb.Workbook = { Views: [{ RTL: true }] };
  XLSX.utils.book_append_sheet(wb, ws, "×“×•×— ×ª×•×¨×™×");
  XLSX.writeFile(wb, `Report_${selectedDate}.xlsx`);
}

function buildCalendar() {
  
  const cal = document.getElementById("calendar");
  cal.innerHTML = "";
  
  const y = currentMonthDate.getFullYear();
  const m = currentMonthDate.getMonth();
  
  document.getElementById("monthYearDisplay").innerText =
  `${["×™× ×•××¨","×¤×‘×¨×•××¨","××¨×¥","××¤×¨×™×œ","×××™","×™×•× ×™","×™×•×œ×™","××•×’×•×¡×˜","×¡×¤×˜××‘×¨","××•×§×˜×•×‘×¨","× ×•×‘××‘×¨","×“×¦××‘×¨"][m]} ${y}`;
  
  const first = new Date(y, m, 1).getDay();
  const days  = new Date(y, m + 1, 0).getDate();
  
  const todayKey = dateToKey(new Date());
  
  const hInput = document.getElementById("historyDays");
  let ret = (hInput && hInput.value) ? parseInt(hInput.value) : 30;
  
  const cut = new Date();
  cut.setDate(cut.getDate() - ret);
  const cutKey = dateToKey(cut);
  
  for (let i = 0; i < first; i++) {
    cal.appendChild(document.createElement("div"));
  }
  
  for (let d = 1; d <= days; d++) {
    
    const k = dateToKey(new Date(y, m, d));
    const div = document.createElement("div");
    
    div.className = "day";
    div.innerText = d;
    div.setAttribute("data-date", k);
    
    if (globalData[k] && globalData[k].settings) {
      div.classList.add("has-slots");
    }
    
    /* ===== ×™××™× ×‘×¢×‘×¨ ===== */
    if (k < todayKey) {
      
      if (!historyMode) {
        div.classList.add("disabled");
        div.onclick = null;
        
      } else if (k < cutKey) {
        div.classList.add("disabled");
        div.onclick = null;
        
      } else {
        div.classList.add("past", "history-available");
        div.onclick = () => {
          if (applyMode) {
            toggleApplyDate(k, div);
          } else {
            renderSlots(k);
          }
        };
      }
      
      /* ===== ×”×™×•× ×•×”×¢×ª×™×“ ===== */
    } else {
      
      if (k === todayKey) {
        div.style.border = "2px solid #FFC107";
      }
      
      div.onclick = () => {
        if (applyMode) {
          toggleApplyDate(k, div);
        } else {
          renderSlots(k);
        }
      };
    }
    
    /* ===== ×¡×™××•× ×™× ===== */
    
    if (selectedApplyDates.has(k)) {
      div.classList.add("apply-selected");
    }
    
    if (k === selectedDate) {
      div.classList.add("selected-day");
    }
    
    cal.appendChild(div);
  }
}

function prevMonth() { currentMonthDate.setMonth(currentMonthDate.getMonth()-1); buildCalendar(); }
function nextMonth() { currentMonthDate.setMonth(currentMonthDate.getMonth()+1); buildCalendar(); }
/* =====================================================
×¤×•× ×§×¦×™×” ×œ××™×ª×•×’ ××¦×‘ ×”×™×¡×˜×•×¨×™×” (×¢× ××™×¤×•×¡ ×œ×”×™×•× ×‘×›×™×‘×•×™)
===================================================== */
function toggleHistoryMode() {
  const toggle = document.getElementById("historyToggle");
  historyMode = toggle.checked;
  
  // ×œ×•×’×™×§×” ×—×“×©×”: ×× ×›×™×‘×™× ×• ××ª ×”×”×™×¡×˜×•×¨×™×” -> ×—×–×•×¨ ×œ×”×™×•×
  if (!historyMode) {
    const now = new Date();
    selectedDate = dateToKey(now);      // ×¢×“×›×•×Ÿ ×”×ª××¨×™×š ×”× ×‘×—×¨ ×œ×”×™×•×
    currentMonthDate = new Date();      // ×”×—×–×¨×ª ×”×œ×•×— ×©× ×” ×œ×—×•×“×© ×”× ×•×›×—×™
  }
  
  // ×¨×¢× ×•×Ÿ ××œ× ×©×œ ×”×××©×§
  buildCalendar();       // ×‘×•× ×” ××—×“×© ××ª ×”×œ×•×— (×¢× ×”×—×•×“×© ×”× ×›×•×Ÿ)
  renderSlots(selectedDate); // ××¦×™×’ ××ª ×”×ª×•×¨×™× ×©×œ ×”×ª××¨×™×š (×”×™×•×)
}
function saveSystemSettings() {
  db.ref().update({ 'settings/historyRetentionDays': document.getElementById("historyDays").value, 'settings/calendarTitle': document.getElementById("calendarTitleSetting").value }).then(()=>alert("× ×©××¨"));
}

function initRealtimeListener() {
  const overlay = document.getElementById("loadingOverlay");
  db.ref('settings').once('value', s => {
    const v = s.val() || {};
    if(v.historyRetentionDays) document.getElementById("historyDays").value = v.historyRetentionDays;
    if(v.calendarTitle) document.getElementById("calendarTitleSetting").value = v.calendarTitle;
  });
  
  db.ref('appointments').on('value', (s) => {
    globalData = s.val() || {};
    overlay.style.display = 'none';
    try { const today = new Date().toDateString(); if (localStorage.getItem('lastClean') !== today) { performHistoryCleanup(globalData); localStorage.setItem('lastClean', today); } } catch(e) {}
    if (!selectedDate) { selectedDate = dateToKey(new Date()); currentMonthDate = new Date(); }
    buildCalendar(); renderSlots(selectedDate);
  }, () => overlay.style.display = 'none');
}

function performHistoryCleanup(allData) {
  if(!allData) return;
  const inp = document.getElementById("historyDays");
  let ret = (inp && inp.value) ? parseInt(inp.value) : 30;
  if (!ret || ret < 1) ret = 30;
  const cut = new Date(); cut.setDate(cut.getDate() - ret); const cutKey = dateToKey(cut);
  let updates = {}, count = 0;
  Object.keys(allData).forEach(k => { if (k.match(/^\d{4}-\d{2}-\d{2}$/) && k < cutKey) { updates[`appointments/${k}`] = null; count++; } });
  if (count > 0) db.ref().update(updates);
}

setInterval(() => { if (selectedDate && selectedDate === dateToKey(new Date())) renderSlots(selectedDate); }, 60000);
initRealtimeListener();

function removeExtraSlot(dateKey, time) {
  if(!confirm("×œ×”×¡×™×¨ ××ª ×”×’×“×œ×ª ×”××›×¡×” ×œ×©×¢×” ×–×•?")) return;
  db.ref(`appointments/${dateKey}/appointments`).once('value', s => {
    let list = s.val() || [];
    const idx = list.findIndex(a => a.time === time && a.status === 'EXTRA_CAPACITY');
    if (idx > -1) {
      list.splice(idx, 1);
      db.ref(`appointments/${dateKey}/appointments`).set(list);
    }
  });
}

/* =====================================================
×•×œ×™×“×¦×™×” ×‘×–××Ÿ ×××ª (××•× ×¢ ×˜×¢×•×™×•×ª ××™×“ ×‘×”×§×œ×“×”)
===================================================== */
document.addEventListener('change', function(e) {
  
  // 1. ×‘×“×™×§×” ×œ×˜×•×•×— ×”×©×¢×•×ª ×”×¨××©×™ (×”×ª×—×œ×”/×¡×™×•×)
  if (e.target.id === 'range1Start' || e.target.id === 'range1End') {
    const startInput = document.getElementById('range1Start');
    const endInput = document.getElementById('range1End');
    
    // ×‘×•×“×§×™× ×¨×§ ×× ×©× ×™ ×”×©×“×•×ª ××œ××™×
    if (startInput.value && endInput.value) {
      if (!isValidTimeCheck(startInput.value, endInput.value)) {
        alert("×©×’×™××”: ×©×¢×ª ×”×¡×™×•× ×—×™×™×‘×ª ×œ×”×™×•×ª ×××•×—×¨×ª ××©×¢×ª ×”×”×ª×—×œ×”.");
        endInput.value = ""; // ××•×—×§ ××ª ×©×¢×ª ×”×¡×™×•× ×”×©×’×•×™×”
      }
    }
  }
  
  // 2. ×‘×“×™×§×” ×œ×”×¤×¡×§×•×ª (××–×”×” ×“×™× ××™×ª ×›×œ ×©×•×¨×” ×©×œ ×”×¤×¡×§×”)
  if (e.target.classList.contains('break-start') || e.target.classList.contains('break-end')) {
    // ××•×¦××™× ××ª ×”×©×•×¨×” ×”×¡×¤×¦×™×¤×™×ª ×©×‘×” ×‘×•×¦×¢ ×”×©×™× ×•×™
    const row = e.target.closest('.break-row');
    const startInput = row.querySelector('.break-start');
    const endInput = row.querySelector('.break-end');
    
    if (startInput.value && endInput.value) {
      if (!isValidTimeCheck(startInput.value, endInput.value)) {
        alert("×©×’×™××” ×‘×”×¤×¡×§×”: ×©×¢×ª ×”×¡×™×•× ×§×•×“××ª ×œ×©×¢×ª ×”×”×ª×—×œ×”.");
        
        endInput.value = ""; // ××•×—×§ ××ª ×©×¢×ª ×”×¡×™×•× ×”×©×’×•×™×”
      }
    }
  }
});

// ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×‘×“×™×§×” (×›×•×œ×œ ×ª××™×›×” ×‘-00:00 ×›×¡×•×£ ×™×•×)
function isValidTimeCheck(s, e) {
  let sMin = timeToMinutes(s);
  let eMin = timeToMinutes(e);
  
  // ×× ×©×¢×ª ×¡×™×•× ×”×™× 00:00 ×•×©×¢×ª ×”×ª×—×œ×” ×”×™× ×œ× 0 -> × ×—×©×‘ ×›-24:00
  if (eMin === 0 && sMin > 0) eMin = 1440;
  
  return eMin > sMin;
}

function saveDayConfig() {
  
  if (!selectedDate) {
    alert("×‘×—×¨ ×ª××¨×™×š ×ª×—×™×œ×”");
    return;
  }
  
  /* ========= 1. ×§×¨×™××ª ×¢×¨×›×™ ×”×˜×•×¤×¡ ========= */
  
  const r1Start = document.getElementById('range1Start').value;
  const r1End = document.getElementById('range1End').value;
  const r1Interval = document.getElementById('range1Interval').value;
  const maxSlotsVal = document.getElementById('maxSlots').value;
  
  if (!r1Start || !r1End || !r1Interval || !maxSlotsVal) {
    alert("× × ×œ××œ× ××ª ×›×œ ×©×“×•×ª ×”×—×•×‘×” (×”×ª×—×œ×”, ×¡×™×•×, ××©×š, ×§×™×‘×•×œ×ª).");
    return;
  }
  
  if (typeof isValidTimeCheck === 'function' && !isValidTimeCheck(r1Start, r1End)) {
    alert("×©×’×™××”: ×©×¢×ª ×”×¡×™×•× ×—×™×™×‘×ª ×œ×”×™×•×ª ×××•×—×¨×ª ××©×¢×ª ×”×”×ª×—×œ×”.");
    return;
  }
  
  /* ========= 2. ×”×¤×¡×§×•×ª ========= */
  
  const breaks = [];
  let breaksError = false;
  
  document.querySelectorAll('.break-row').forEach(row => {
    const inputs = row.querySelectorAll('.time-input');
    if (inputs.length === 2) {
      const valStart = inputs[0].value;
      const valEnd = inputs[1].value;
      
      if (valStart && valEnd) {
        if (typeof isValidTimeCheck === 'function' && !isValidTimeCheck(valStart, valEnd)) {
          breaksError = true;
        } else {
          breaks.push({ start: valStart, end: valEnd });
        }
      }
    }
  });
  
  if (breaksError) {
    alert("×©×’×™××” ×‘×”×¤×¡×§×•×ª: ×™×© ×”×¤×¡×§×” ×©×‘×” ×©×¢×ª ×”×¡×™×•× ×§×•×“××ª ×œ×”×ª×—×œ×”.");
    return;
  }
  
  /* ========= 3. ××•×‘×™×™×§×˜ ×”×’×“×¨×•×ª ========= */
  
const settingsObj = {
  range1Start: r1Start,
  range1End: r1End,
  range1Interval: r1Interval,
  maxSlots: String(maxSlotsVal),
  breaks: breaks,
  enableFulfillment: enableFulfillment   // âœ… ×¨×§ ×–×”
};

  
  /* ========= 4. ×§×‘×™×¢×ª ×ª××¨×™×›×™× ×œ×”×—×œ×” ========= */
  
  let datesToApply = [];
  
  if (applyMode && selectedApplyDates.size > 0) {
    // ğŸ”µ ××¦×‘ ×”×—×œ×” ×œ×¤×™ ×ª××¨×™×›×™× × ×‘×—×¨×™×
    datesToApply = Array.from(selectedApplyDates);
    
  } else {
    // ğŸŸ¢ ××¦×‘ ×¨×’×™×œ â€“ ×™××™× ×§×“×™××”
    const daysInput = document.getElementById("daysToApply");
    const days = daysInput ? (parseInt(daysInput.value) || 1) : 1;
    
    const start = new Date(selectedDate);
    
    for (let i = 0; i < days; i++) {
      const d = new Date(start);
      d.setDate(d.getDate() + i);
      datesToApply.push(dateToKey(d));
    }
  }
  
  if (datesToApply.length === 0) {
    alert("×œ× × ×‘×—×¨×• ×ª××¨×™×›×™× ×œ×”×—×œ×”");
    return;
  }
  
  /* ========= 5. ×‘× ×™×™×ª ×¢×“×›×•×Ÿ ========= */
  
  const updates = {};
  
  datesToApply.forEach(k => {
    updates[`appointments/${k}/settings`] = settingsObj;
    
    if (!globalData[k]) globalData[k] = {};
    globalData[k].settings = settingsObj;
  });
  
  if (typeof db === 'undefined') {
    alert("×©×’×™××” ×§×¨×™×˜×™×ª: ××™×Ÿ ×—×™×‘×•×¨ ×œ××¡×“ ×”× ×ª×•× ×™×.");
    return;
  }
  
  /* ========= 6. ×©××™×¨×” ========= */
  
  db.ref().update(updates)
  .then(() => {
    
    alert(`×”×”×’×“×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×” ×œ-${datesToApply.length} ×ª××¨×™×›×™×`);
    
    // × ×™×§×•×™ ××¦×‘ ×”×—×œ×”
    applyMode = false;
    selectedApplyDates.clear();
    
    const daysInput = document.getElementById("daysToApply");
    if (daysInput) {
      daysInput.disabled = false;
      daysInput.style.opacity = "1";
    }
    
    const hint = document.getElementById("applyDatesHint");
    if (hint) hint.style.display = "none";
    
    buildCalendar();
    renderSlots(selectedDate);
  })
  .catch(error => {
    console.error("Error saving settings:", error);
    alert("×©×’×™××” ×‘×©××™×¨×”: " + error.message);
  });
}

/* =====================================================
×¤×•× ×§×¦×™×” ×œ×”×“×¤×¡×ª ×“×•×— ×™×•××™ - ×’×¨×¡×” ××©×•×¤×¨×ª ×•××ª×•×§× ×ª
===================================================== */
function printDailyReport() {
  // --- 1. ×‘×“×™×§×•×ª ××§×“×™××•×ª ---
  if (typeof selectedDate === 'undefined' || !selectedDate) {
    alert("×™×© ×œ×‘×—×•×¨ ×™×•× ××”×œ×•×— ×œ×¤× ×™ ×”×¤×§×ª ×”×“×•×—.");
    return;
  }
  
  if (typeof globalData === 'undefined' || !globalData[selectedDate] || !globalData[selectedDate].appointments) {
    alert("××™×Ÿ × ×ª×•× ×™× ×œ×”×“×¤×¡×” ×‘×™×•× ×–×”.");
    return;
  }
  
  // --- 2. ×©×œ×™×¤×ª ×”× ×ª×•× ×™× ×•×¡×™× ×•×Ÿ ---
  var dayData = globalData[selectedDate];
  var bookings = [];
  
  // ×©×œ×™×¤×ª ×¨×§ ×ª×•×¨×™× ×¤×¢×™×œ×™× ×¢× ×˜×œ×¤×•×Ÿ
  for (var i = 0; i < dayData.appointments.length; i++) {
    var item = dayData.appointments[i];
    if (item.phone && item.status !== 'DELETED') {
      bookings.push(item);
    }
  }
  
  // ××™×•×Ÿ ×œ×¤×™ ×©×¢×”
  bookings.sort(function(a, b) {
    return (a.time || '').localeCompare(b.time || '');
  });
  
  if (bookings.length === 0) {
    alert("××™×Ÿ ×ª×•×¨×™× ××•×–×× ×™× ×‘×™×•× ×–×”.");
    return;
  }
  
  // --- 3. ×”×›× ×ª ××©×ª× ×™× ×œ×›×•×ª×¨×ª ---
  var titleEl = document.getElementById("calendarTitleSetting");
  var businessName = (titleEl && titleEl.value) ? titleEl.value : "×“×•×— ×ª×•×¨×™×";
  var dateParts = selectedDate.split('-');
  var displayDate = dateParts[2] + '/' + dateParts[1] + '/' + dateParts[0];
  
  // --- 4. ×‘× ×™×™×ª ×”-HTML (×‘×××¦×¢×•×ª ××¢×¨×š ×œ×× ×™×¢×ª ×©×’×™××•×ª) ---
  var htmlParts = [];
  
  // ×›×•×ª×¨×•×ª ×•×¢×™×¦×•×‘ CSS
  htmlParts.push('<!DOCTYPE html><html lang="he" dir="rtl"><head><title>Print Report</title>');
  htmlParts.push('<style>');
  htmlParts.push('body { font-family: "Segoe UI", Arial, sans-serif; padding: 20px; direction: rtl; color: #333; }');
  htmlParts.push('h1 { text-align: center; margin: 0; font-size: 24px; }');
  htmlParts.push('.meta { text-align: center; margin-bottom: 15px; font-size: 16px; color: #555; }');
  htmlParts.push('table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }');
  htmlParts.push('th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: right; }');
  htmlParts.push('th { background-color: #f2f2f2; font-weight: bold; border-bottom: 2px solid #999; }');
  htmlParts.push('tr:nth-child(even) { background-color: #fafafa; }');
  htmlParts.push('@media print { body { -webkit-print-color-adjust: exact; } th { background-color: #eee !important; } }');
  htmlParts.push('</style></head><body>');
  
  // ×ª×•×›×Ÿ ×”×“×£
  htmlParts.push('<h1>' + businessName + '</h1>');
  htmlParts.push('<div class="meta">×ª××¨×™×š: <b>' + displayDate + '</b> | ×¡×”"×› ×ª×•×¨×™×: <b>' + bookings.length + '</b></div>');
  
  // ×›×•×ª×¨×•×ª ×”×˜×‘×œ×” (××ª×•×§×Ÿ: 4 ×¢××•×“×•×ª ×›×•×œ×œ ×©× ×¤×¨×˜×™ ×•×©× ××©×¤×—×”)
  htmlParts.push('<table><thead><tr>');
  htmlParts.push('<th width="5%">#</th>');
  htmlParts.push('<th width="15%">×©×¢×”</th>');
  htmlParts.push('<th width="20%">×©× ×¤×¨×˜×™</th>');
  htmlParts.push('<th width="20%">×©× ××©×¤×—×”</th>');
  htmlParts.push('<th width="40%">×˜×œ×¤×•×Ÿ</th>');
  htmlParts.push('</tr></thead><tbody>');
  
  // ×©×•×¨×•×ª ×”×˜×‘×œ×”
  for (var j = 0; j < bookings.length; j++) {
    var appt = bookings[j];
    var firstName = appt.first || '';
    var lastName = appt.last || '';
    
    htmlParts.push('<tr>');
    htmlParts.push('<td>' + (j + 1) + '</td>');
    htmlParts.push('<td style="font-weight:bold;">' + (appt.time || '') + '</td>');
    htmlParts.push('<td>' + firstName + '</td>');
    htmlParts.push('<td>' + lastName + '</td>');
    htmlParts.push('<td>' + (appt.phone || '') + '</td>');
    htmlParts.push('</tr>');
  }
  
  htmlParts.push('</tbody></table>');
  
  // ×¡×’×™×¨×” ×‘×˜×•×—×” ×©×œ ×”-HTML ×”×¤× ×™××™
  htmlParts.push('<' + '/body><' + '/html>');
  
  var finalHtml = htmlParts.join('');
  
  // --- 5. ×¤×ª×™×—×ª ×—×œ×•×Ÿ ×•×”×“×¤×¡×” ---
  var printWindow = window.open('', '_blank', 'width=900,height=800');
  if (printWindow) {
    printWindow.document.write(finalHtml);
    printWindow.document.close(); // ×¡×’×™×¨×ª ×›×ª×™×‘×”
    
    // ×˜×™×™××¨ ×§×¦×¨ ×œ×•×•×“× ×˜×¢×™× ×” ×•××– ×”×“×¤×¡×”
    setTimeout(function() {
      printWindow.focus();
      printWindow.print();
    }, 500);
  } else {
    alert("×”×“×¤×“×¤×Ÿ ×—×¡× ××ª ×”×—×œ×•×Ÿ ×”×§×•×¤×¥. ×™×© ×œ××©×¨ ×—×œ×•× ×•×ª ×§×•×¤×¦×™×.");
  }
}
// --- ×¤×•× ×§×¦×™×•×ª ×œ× ×™×”×•×œ ×—×œ×•×Ÿ ×”×“×•×—×•×ª ---

function openReportModal() {
  // ×”×¦×’×ª ×”×—×œ×•×Ÿ (×©×™× ×œ×‘: ×™×™×ª×›×Ÿ ×©××¦×œ×š ×–×” block ××• flex, ×”×©××¨×ª×™ ××ª ×‘×¨×™×¨×ª ×”××—×“×œ)
  document.getElementById('reportModal').style.display = 'flex';
  
  // --- ×—×™×©×•×‘ ×”×ª××¨×™×š ×©×œ ×”×™×•× ---
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0'); // ×—×•×“×©×™× ××ª×—×™×œ×™× ×‘-0
  const day = String(now.getDate()).padStart(2, '0');
  
  // ×¤×•×¨××˜ ×©××ª××™× ×œ×©×“×•×ª ×ª××¨×™×š ×‘-HTML: YYYY-MM-DD
  const todayStr = `${year}-${month}-${day}`;
  
  // --- ××™×¤×•×¡ ×”×©×“×•×ª ---
  document.getElementById('repStart').value = todayStr; // ×”×ª×—×œ×”: ×”×™×•×
  document.getElementById('repEnd').value = todayStr;   // ×¡×™×•×: ×”×™×•×
  document.getElementById('repPhone').value = '';       // ×˜×œ×¤×•×Ÿ: × ×§×™
}

function closeReportModal() {
  // ×”×¡×ª×¨×ª ×”×—×œ×•×Ÿ
  document.getElementById('reportModal').style.display = 'none';
  
  // × ×™×§×•×™ ×©×“×” ×”×˜×œ×¤×•×Ÿ ×›×“×™ ×©×™×”×™×” ×¨×™×§ ×‘×¤×¢× ×”×‘××”
  document.getElementById('repPhone').value = '';
}

async function printRangeReport() {
  const startVal = document.getElementById('repStart').value;
  const endVal = document.getElementById('repEnd').value;
  const phoneVal = document.getElementById('repPhone').value.trim();
  
  if (!startVal || !endVal || !phoneVal) {
    alert("× × ×œ××œ× ×ª××¨×™×š ×”×ª×—×œ×”, ×ª××¨×™×š ×¡×™×•× ×•××¡×¤×¨ ×˜×œ×¤×•×Ÿ.");
    return;
  }
  
  const startDate = new Date(startVal);
  const endDate = new Date(endVal);
  
  if (startDate > endDate) {
    alert("×ª××¨×™×š ×”×”×ª×—×œ×” ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤× ×™ ×ª××¨×™×š ×”×¡×™×•×.");
    return;
  }
  
  // ×”×¦×’×ª ×˜×•×¢×Ÿ (××•×¤×¦×™×•× ×œ×™, ×× ×™×© ×œ×š ××œ×× ×˜ ×›×–×”)
  const loading = document.getElementById('loadingOverlay');
  if (loading) loading.style.display = 'flex';
  
  const foundAppointments = [];
  const loopDate = new Date(startDate);
  
  // ×œ×•×œ××” ×¢×œ ×›×œ ×”×ª××¨×™×›×™× ×‘×˜×•×•×—
  while (loopDate <= endDate) {
    const dateKey = loopDate.toISOString().split('T')[0];
    
    // ×©×œ×™×¤×ª × ×ª×•× ×™× ××”×¤×™×™×¨×‘×™×™×¡ (×›×“×™ ×œ×”×‘×˜×™×— ×©×™×© ×œ× ×• ×”×›×œ, ×’× ×× ×œ× × ×˜×¢×Ÿ ××§×•××™×ª)
    try {
      const snapshot = await db.ref('appointments/' + dateKey).once('value');
      const dayData = snapshot.val();
      
      if (dayData && dayData.appointments) {
        // ××¢×‘×¨ ×¢×œ ×”×ª×•×¨×™× ×©×œ ××•×ª×• ×™×•×
        dayData.appointments.forEach(appt => {
          // ×‘×“×™×§×” ×× ×”×˜×œ×¤×•×Ÿ ××›×™×œ ××ª ×”××¡×¤×¨ ×©×”×•×–×Ÿ (×”×ª×××” ×—×œ×§×™×ª ××• ××œ××”)
          if (appt && appt.phone && appt.phone.includes(phoneVal) && appt.status !== 'DELETED') {
            foundAppointments.push({
              date: dateKey,
              time: appt.time,
              name: (appt.first || '') + ' ' + (appt.last || ''),
              phone: appt.phone
            });
          }
        });
      }
    } catch (err) {
      console.error("Error fetching date: " + dateKey, err);
    }
    
    // ×§×™×“×•× ×œ×™×•× ×”×‘×
    loopDate.setDate(loopDate.getDate() + 1);
  }
  
  if (loading) loading.style.display = 'none';
  closeReportModal();
  
  if (foundAppointments.length === 0) {
    alert("×œ× × ××¦××• ×ª×•×¨×™× ×œ××¡×¤×¨ ×–×” ×‘×˜×•×•×— ×”×ª××¨×™×›×™× ×©× ×‘×—×¨.");
    return;
  }
  
  // --- ×™×¦×™×¨×ª ×”-HTML ×œ×”×“×¤×¡×” ---
  const htmlParts = [];
  htmlParts.push('<html><head><title>×“×•×— ×ª×•×¨×™× ××¨×•×›×–</title>');
  htmlParts.push('<style>');
  htmlParts.push('body { font-family: "Segoe UI", sans-serif; direction: rtl; padding: 20px; }');
  htmlParts.push('table { width: 100%; border-collapse: collapse; margin-top: 20px; }');
  htmlParts.push('th, td { border: 1px solid #ccc; padding: 8px; text-align: right; }');
  htmlParts.push('th { background-color: #f0f0f0; }');
  htmlParts.push('.header { text-align: center; margin-bottom: 20px; }');
  htmlParts.push('</style></head><body>');
  
  htmlParts.push('<div class="header">');
  htmlParts.push('<h1>×“×•×— ×ª×•×¨×™× ××¨×•×›×–</h1>');
  htmlParts.push(`<p>×¢×‘×•×¨ ×˜×œ×¤×•×Ÿ: <strong>${phoneVal}</strong></p>`);
  htmlParts.push(`<p>×˜×•×•×—: ${startVal} - ${endVal}</p>`);
  htmlParts.push('</div>');
  
  htmlParts.push('<table>');
  htmlParts.push('<thead><tr><th>×ª××¨×™×š</th><th>×©×¢×”</th><th>×©× ×”×œ×§×•×—</th><th>×˜×œ×¤×•×Ÿ</th></tr></thead>');
  htmlParts.push('<tbody>');
  
  // ××™×•×Ÿ ×”×ª×•×¦××•×ª ×œ×¤×™ ×ª××¨×™×š ×•×©×¢×”
  foundAppointments.sort((a, b) => {
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    return a.time.localeCompare(b.time);
  });
  
  foundAppointments.forEach(item => {
    // ×”××¨×ª ×ª××¨×™×š ×œ×¤×•×¨××˜ ×™×¤×” ×™×•×ª×¨ (DD/MM/YYYY)
    const dateParts = item.date.split('-');
    const prettyDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
    
    htmlParts.push('<tr>');
    htmlParts.push(`<td>${prettyDate}</td>`);
    htmlParts.push(`<td>${item.time}</td>`);
    htmlParts.push(`<td>${item.name}</td>`);
    htmlParts.push(`<td>${item.phone}</td>`);
    htmlParts.push('</tr>');
  });
  
  htmlParts.push('</tbody></table>');
  htmlParts.push('<div style="margin-top:20px; text-align:center;"><button onclick="window.print()">×”×“×¤×¡ ×“×•×—</button></div>');
  htmlParts.push('<' + '/body><' + '/html>');
  
  const printWindow = window.open('', '_blank', 'width=900,height=800');
  printWindow.document.write(htmlParts.join(''));
  printWindow.document.close();
}
function logoutAdmin() {
  firebase.auth().signOut().then(() => {
    // ×”×ª× ×ª×§×•×ª ×”×¦×œ×™×—×” - ×”×¢×‘×¨×” ×œ×“×£ ×”×›× ×™×¡×”
    window.location.href = 'admin-login.html';
  }).catch((error) => {
    console.error("Logout error:", error);
    alert('×©×’×™××” ×‘×”×ª× ×ª×§×•×ª');
  });
}
/* ==========================================
×× ×’× ×•×Ÿ ×”×–×× ×ª ×ª×•×¨ ×œ×× ×”×œ (×œ×œ× ×”×’×‘×œ×”)
========================================== */

// ××©×ª× ×™× ×œ×©××™×¨×ª ×¤×¨×˜×™ ×”×œ×§×•×— ×‘×™×Ÿ ×”×–×× ×•×ª
// ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×œ× ×™×”×•×œ ×”×–×× ×•×ª ×× ×”×œ
let cachedClient = { first: '', last: '', phone: '' };
let clientCacheTimer = null; // <--- ×–×• ×”×©×•×¨×” ×”×—×¡×¨×” ×©×’×•×¨××ª ×œ×©×’×™××”
let currentBookingTime = null;

// ×¤×•× ×§×¦×™×” ×œ×¤×ª×™×—×ª ×”×—×œ×•×Ÿ (×ª×•×¤×¢×œ ×‘×œ×—×™×¦×” ×¢×œ ×ª×•×¨ ×¤× ×•×™)
function openBookingWindow(time) {
  currentBookingTime = time;
  document.getElementById('bookingTimeDisplay').value = time;
  
  // ×× ×™×© ×¤×¨×˜×™× ×‘×–×™×›×¨×•×Ÿ (××”×–×× ×” ×©×‘×•×¦×¢×” ×‘-5 ×”×“×§×•×ª ×”××—×¨×•× ×•×ª)
  if (cachedClient.phone && cachedClient.phone !== '') {
    document.getElementById('bookFirstName').value = cachedClient.first;
    document.getElementById('bookLastName').value = cachedClient.last;
    document.getElementById('bookPhone').value = cachedClient.phone;
  } else {
    // ××™×Ÿ ×¤×¨×˜×™× - ×× ×§×™×
    document.getElementById('bookFirstName').value = '';
    document.getElementById('bookLastName').value = '';
    document.getElementById('bookPhone').value = '';
  }
  
  document.getElementById('adminBookingModal').style.display = 'flex';
  
  // ×× ×”×©× ×¨×™×§, ×©×™× ×¢×œ×™×• ×¤×•×§×•×¡
  if(!document.getElementById('bookFirstName').value) {
    document.getElementById('bookFirstName').focus();
  }
}

// ×¡×’×™×¨×ª ×”×—×œ×•×Ÿ
function closeBookingModal() {
  document.getElementById('adminBookingModal').style.display = 'none';
}

// ×‘×™×¦×•×¢ ×”×”×–×× ×” ×•×©××™×¨×” ×œ×¤×™×™×¨×‘×™×™×¡
function submitAdminBooking() {
  const first = document.getElementById('bookFirstName').value.trim();
  const last = document.getElementById('bookLastName').value.trim();
  let phone = document.getElementById('bookPhone').value.trim();
  const time = currentBookingTime;
  
  phone = phone.replace(/\D/g, ''); // × ×™×§×•×™ ×ª×•×•×™× ×œ× ×¨×¦×•×™×™×
  
  // ×‘×“×™×§×•×ª ×ª×§×™× ×•×ª
  if (!first || !time) {
    alert("×—×•×‘×” ×œ××œ× ×©× ×¤×¨×˜×™");
    return;
  }
  
  if (phone.length !== 10) {
    alert("××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×—×™×™×‘ ×œ×”×›×™×œ 10 ×¡×¤×¨×•×ª ×‘×“×™×•×§");
    return;
  }
  
  // ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ ×”×ª×•×¨
  const newAppt = {
    time: time,
    first: first,
    last: last,
    phone: phone,
    status: "BOOKED",
    bookedBy: "ADMIN",
    timestamp: Date.now()
  };
  
  // ×©×œ×™×—×” ×œ×¤×™×™×¨×‘×™×™×¡
  db.ref(`appointments/${selectedDate}/appointments`).once('value', snapshot => {
    let list = snapshot.val() || [];
    list.push(newAppt);
    
    db.ref(`appointments/${selectedDate}/appointments`).set(list)
    .then(() => {
      // === × ×™×”×•×œ ×–×™×›×¨×•×Ÿ ××•×˜×•××˜×™ (×ª××™×“ ×¤×•×¢×œ) ===
      
      // ××™×¤×•×¡ ×˜×™×™××¨ ×§×•×“× ×× ×§×™×™×
      if (clientCacheTimer) clearTimeout(clientCacheTimer);
      
      // ×©××™×¨×ª ×¤×¨×˜×™× ×‘×–×™×›×¨×•×Ÿ
      cachedClient = { first, last, phone };
      
      // ×”×¤×¢×œ×ª ×˜×™×™××¨ ×œ-5 ×“×§×•×ª ×œ××—×™×§×ª ×”×–×™×›×¨×•×Ÿ
      clientCacheTimer = setTimeout(() => {
        cachedClient = { first: '', last: '', phone: '' };
        console.log("×¤×¨×˜×™ ×”×œ×§×•×— × ××—×§×• ××”×–×™×›×¨×•×Ÿ (×¢×‘×¨×• 5 ×“×§×•×ª)");
      }, 300000);
      
      closeBookingModal();
    })
    .catch(err => {
      alert("×©×’×™××” ×‘×©××™×¨×”: " + err.message);
    });
  });
}
</script>
<script>
// ==========================================
// ×—×œ×§ 1: ×œ×•×’×™×§×ª ××¡×š ××œ× (×œ×œ× ×©×™× ×•×™)
// ==========================================
function toggleFullScreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(err => {
      console.log("×©×’×™××” ×‘×›× ×™×¡×” ×œ××¡×š ××œ×:", err);
    });
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    }
  }
}

document.addEventListener('fullscreenchange', () => {
  const fullScreenBtn = document.getElementById('fullscreenBtn');
  if (fullScreenBtn) {
    if (document.fullscreenElement) {
      fullScreenBtn.style.display = 'none';
    } else {
      fullScreenBtn.style.display = 'inline-flex';
    }
  }
});

// ==========================================
// ×—×œ×§ 2: ×¨×™×©×•× Service Worker (×—×•×‘×”!)
// ==========================================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js')
  .then(() => console.log('Service Worker Registered'))
  .catch(err => console.log('SW Error:', err));
}

// ==========================================
// ×—×œ×§ 3: ×œ×•×’×™×§×ª ×”×ª×§× ×” ×”×—×“×©×” (×”×ª×™×§×•×Ÿ)
// ==========================================
let deferredPrompt = null;
const installBtn = document.getElementById('installAppBtn');

// ×. ×”××–× ×” ×œ×œ×—×™×¦×” ×¢×œ ×”×›×¤×ª×•×¨ (×‘××§×•× onclick ×‘-HTML)
if (installBtn) {
  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) {
      return;
    }
    // ×”×¤×¢×œ×ª ×”×—×œ×•× ×™×ª
    deferredPrompt.prompt();
    // ×”××ª× ×” ×œ×ª×©×•×‘×ª ×”××©×ª××©
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`User response: ${outcome}`);
    
    deferredPrompt = null;
    
    if (outcome === 'accepted') {
      installBtn.style.display = 'none';
    }
  });
}

// ×‘. ×–×™×”×•×™ ×©×”×“×¤×“×¤×Ÿ ××•×›×Ÿ ×œ×”×ª×§× ×”
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  // ×”×¦×’×ª ×”×›×¤×ª×•×¨
  if (installBtn) {
    installBtn.style.display = 'block';
    console.log('Install button is visible');
  }
});

// ×’. ×”×¡×ª×¨×” ×× ×›×‘×¨ ××•×ª×§×Ÿ
window.addEventListener('DOMContentLoaded', () => {
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
  window.navigator.standalone ||
  document.referrer.includes('android-app://');
  
  if (isStandalone) {
    if (installBtn) installBtn.remove();
  }
});

// ×“. ××™×¨×•×¢ ×”×¦×œ×—×”
window.addEventListener('appinstalled', () => {
  if (installBtn) installBtn.style.display = 'none';
});

function toggleApplyDate(dateKey, dayElement) {
  
  if (selectedApplyDates.has(dateKey)) {
    selectedApplyDates.delete(dateKey);
    dayElement.classList.remove("apply-selected");
  } else {
    selectedApplyDates.add(dateKey);
    dayElement.classList.add("apply-selected");
  }
  
}
function toggleEnableFulfillment() {
  enableFulfillment = !enableFulfillment;

  const btn = document.getElementById('enableFulfillmentBtn');
  if (enableFulfillment) {
    btn.classList.add('on');
  } else {
    btn.classList.remove('on');
  }
}

</script>

</body>

</html>
